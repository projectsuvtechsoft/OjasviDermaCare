<!-- <div class="container mx-auto p-4"> -->
<!-- <p class="text-center text-lg text-gray-700 mb-6">
    This is your main page content. The address drawer will open over this.
  </p> -->

<!-- <div class="text-center">
    <button
      class="bg-[#5a8f69] text-white px-6 py-3 text-base rounded hover:bg-[#5a8f69]/90 transition"
      (click)="openAddressDrawer()"
    >
      Add new address
    </button>
  </div> -->

<!-- <div
  *ngIf="addressDrawerOpen"
  class="fixed inset-0 flex justify-end bg-black/50 z-50 transition-opacity duration-300"
  [class.opacity-100]="addressDrawerOpen"
  [class.opacity-0]="!addressDrawerOpen"
  (click)="closeAddressDrawer()"
>
  <div
    class="bg-white h-full w-full max-w-lg p-4 text-left shadow-sm text-sm transform transition-transform duration-300 ease-out flex flex-col"
    [class.translate-x-0]="addressDrawerOpen"
    [class.translate-x-full]="!addressDrawerOpen"
    (click)="$event.stopPropagation()"
  >
    <div
      class="flex justify-between items-center pb-4 mb-4 border-b border-gray-200"
    >
      <h2 class="text-xl font-semibold text-gray-800">Address Management</h2>
      <button
        (click)="closeAddressDrawer()"
        class="text-gray-500 hover:text-gray-700"
      >
        <i class="ri-close-line text-2xl"></i>
      </button>
    </div>
 
    <div *ngIf="!showAddressForm" class="flex-grow overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
          <i class="ri-map-pin-line text-[#5a8f69] text-xl mr-2"></i>
          Your Saved Addresses
        </h3>
        <button
          class="bg-[#5a8f69] text-white px-4 py-2 text-sm rounded hover:bg-[#5a8f69]/90 transition"
          (click)="openAddressForm(null)"
        >
          + Add New Address
        </button>
      </div>
 
      <div *ngIf="savedAddresses.length > 0" class="grid grid-cols-1 gap-6">
        <div
          *ngFor="let address of savedAddresses"
          class="border border-gray-200 rounded-lg p-4 bg-white relative hover:shadow-md transition-shadow duration-200"
        >
          <div class="flex justify-between items-start">
            <div>
              <p class="font-semibold text-gray-800">{{ address.NAME }}</p>
              <p class="text-sm text-gray-600 mt-1">
                {{ address.ADDRESS }}<br />
                {{ address.CITY }}, {{ address.CITY }}
              </p>
              <p class="text-sm text-gray-600 mt-1">
                {{
                  commonFunction.decryptdata(encryptedmobno) ||
                    "Phone not provided"
                }}
              </p>
              <span
                *ngIf="address.IS_DEFAULT"
                class="inline-block text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded mt-2"
                >Default</span
              >
              <span
                *ngIf="address.ADDRESS_TYPE"
                class="inline-block text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded mt-2 ml-1"
                >{{ address.ADDRESS_TYPE }}</span
              >
            </div>
            <div class="space-x-2">
              <button
                class="text-gray-500 hover:text-[#5a8f69] transition"
                title="Edit"
                (click)="openAddressForm(address.ID)"
              >
                <i class="ri-edit-2-line"></i>
              </button>
            </div>
          </div>
          <button
            (click)="selectAddressForDelivery(address); closeAddressDrawer()"
            class="mt-4 w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-[#5a8f69] hover:bg-[#4a7a58] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#5a8f69]"
          >
            Deliver Here
          </button>
        </div>
      </div>
 
     
    </div>
 
    <div *ngIf="showAddressForm" class="flex-grow overflow-y-auto">
      <h3 class="text-lg font-semibold mb-4">
        {{ isEditingAddress ? "Edit Address" : "Add New Address" }}
      </h3>
      <form (ngSubmit)="saveAddress()">
        <div class="mb-2">
          <label class="block mb-1 font-medium">* Full Name</label>
          <input
            type="text"
            [(ngModel)]="addressForm.NAME"
            name="customerName"
            class="w-full border rounded px-2 py-1 text-sm"
            placeholder="Enter Full Name"
            required
          />
        </div>
        <div class="mb-2">
          <label class="block mb-1 font-medium">* Mobile Number</label>
          <input
            type="tel"
            [(ngModel)]="addressForm.MOBILE_NO"
            name="mobileNumber"
            class="w-full border rounded px-2 py-1 text-sm"
            placeholder="Enter Mobile Number"
            required
          />
        </div>
        <div class="mb-2">
          <label class="block mb-1 font-medium">* Street Address</label>
          <textarea
            [(ngModel)]="addressForm.ADDRESS"
            name="streetAddress"
            class="w-full border rounded px-2 py-1 text-sm"
            placeholder="House No., Building, Street, Area"
            required
          ></textarea>
        </div>
        <div class="flex gap-2 mb-2">
          <div class="flex-1">
            <label class="block mb-1 font-medium">* Country</label>
            <select
              [(ngModel)]="addressForm.COUNTRY_ID"
              name="country"
              class="w-full border rounded px-2 py-1 text-sm"
              (change)="onCountryChange(addressForm.COUNTRY_ID!)"
              required
            >
              <option value="">Select Country</option>
              <option *ngFor="let c of countryList" [value]="c.ID">
                {{ c.NAME }}
              </option>
            </select>
          </div>
          <div class="flex-1">
            <label class="block mb-1 font-medium">* State</label>
            <select
              [(ngModel)]="addressForm.STATE_ID"
              name="state"
              class="w-full border rounded px-2 py-1 text-sm"
              required
            >
              <option value="">Select State</option>
              <option *ngFor="let s of stateList" [value]="s.ID">
                {{ s.NAME }}
              </option>
            </select>
          </div>
        </div>
        <div class="flex gap-2 mb-2">
          <div class="flex-1">
            <label class="block mb-1 font-medium">* City</label>
            <input
              [(ngModel)]="addressForm.CITY"
              name="city"
              class="w-full border rounded px-2 py-1 text-sm"
              placeholder="Enter City"
              required
            />
          </div>
          <div class="flex-1">
            <label class="block mb-1 font-medium">* Zipcode</label>
            <input
              [(ngModel)]="addressForm.PINCODE"
              name="pincode"
              class="w-full border rounded px-2 py-1 text-sm"
              placeholder="Enter Zipcode"
              required
            />
          </div>
        </div>
        <div class="flex gap-2 mb-2">
          <div class="flex-1">
            <label class="block mb-1 font-medium">Landmark</label>
            <input
              [(ngModel)]="addressForm.LANDMARK"
              name="landmark"
              class="w-full border rounded px-2 py-1 text-sm"
              placeholder="E.g., Near Apollo Hospital"
            />
          </div>
          <div class="flex-1">
            <label class="block mb-1 font-medium">Area</label>
            <input
              [(ngModel)]="addressForm.LOCALITY"
              name="area"
              class="w-full border rounded px-2 py-1 text-sm"
              placeholder="E.g., Bandra West"
            />
          </div>
        </div>
        <div class="flex gap-2 mb-2 items-center">
          <div class="flex-1">
            <label class="block mb-1 font-medium">* Address Type</label>
            <label class="mr-2">
              <input
                type="radio"
                [(ngModel)]="addressForm.ADDRESS_TYPE"
                name="addressType"
                value="R"
                required
              />
              Residential
            </label>
            <label>
              <input
                type="radio"
                [(ngModel)]="addressForm.ADDRESS_TYPE"
                name="addressType"
                value="O"
                required
              />
              Office
            </label>
          </div>
          <div class="flex-1 flex items-center">
            <label class="block mb-1 font-medium mr-2"
              >Mark Default Address</label
            >
            <input
              type="checkbox"
              [(ngModel)]="addressForm.IS_DEFAULT"
              name="isDefault"
            />
          </div>
        </div>
        <div class="flex justify-end gap-2 mt-3">
          <button
            type="button"
            (click)="goBackToAddressList()"
            class="bg-gray-200 px-3 py-1.5 rounded text-xs font-medium hover:bg-gray-300 transition"
          >
            Back to List
          </button>
          <button
            type="submit"
            class="bg-[#5a8f69] text-white px-3 py-1.5 rounded text-xs font-medium hover:bg-opacity-90 transition"
          >
            {{ isEditingAddress ? "Update" : "Add" }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div> -->
<!-- </div> -->
<!-- <div
  *ngIf="addressDrawerOpen"
  class="fixed inset-0 flex justify-end bg-black/50 z-50 transition-opacity duration-300"
  [class.opacity-100]="addressDrawerOpen"
  [class.opacity-0]="!addressDrawerOpen"
  (click)="closeAddressDrawer()"
> -->
<div
  class="drawer-overlay"
  [class.open]="addressDrawerOpen"
  (click)="closeAddressDrawer()"
>
  <div *ngIf="loadingScreen">
    <app-common-loader></app-common-loader>
  </div>
  <div class="drawer-content" (click)="$event.stopPropagation()">
    <header class="navbar">
      <div class="logo-section">
        <img
          src="assets/img/logo1.png"
          alt="Ojasvi Logo"
          class="h-12 sm:h-16 md:h-20 w-auto object-contain"
        />
        <div class="flex flex-col logo-text-container">
          <span
            class="text-lg sm:text-xl md:text-2xl text-[#5a8f69] font-semibold"
          >
            Ojasvi Derma Care
          </span>
          <span
            class="text-xs sm:text-sm font-[Pacifico,sans-serif] text-[#ffc200]"
          >
            From Garden To Glow
          </span>
        </div>
      </div>

      <!-- <div class="progress-bar">
        <span class="progress-step completed-step" (click)="goToStep('cart')"
          >CART</span
        >
        <span class="progress-separator completed-separator">--------</span>

        <span
          class="progress-step"
          [class]="isStepActive('address') ? 'active-step' : 'completed-step'"
          (click)="goToStep('address')"
          >ADDRESS</span
        >
        <span
          class="progress-separator"
          [class]="
            isStepActive('payment')
              ? 'completed-separator'
              : 'inactive-separator'
          "
          >--------</span
        >

        <span
          class="progress-step"
          [class]="isStepActive('payment') ? 'active-step' : 'inactive-step'"
          (click)="goToStep('payment')"
          >PAYMENT</span
        >
      </div> -->
      <div class="progress-bar">
        <div class="progress-step-container" (click)="goToStep('cart')">
          <div class="circle completed">
            <span class="circle active">1</span>
          </div>
          <span class="label">CART</span>
        </div>

        <div class="line completed"></div>

        <div
          class="progress-step-container"
          (click)="goToStep('address')"
          [class.active]="isStepActive('address')"
        >
          <div class="circle active">
            <span>2</span>
          </div>
          <span class="label">ADDRESS</span>
        </div>

        <div class="line"></div>

        <div
          class="progress-step-container"
          (click)="goToStep('payment')"
          [class.waiting]="!isStepActive('payment')"
        >
          <div class="circle waiting">
            <span>3</span>
          </div>
          <span class="label">PAYMENT</span>
        </div>
      </div>
    </header>

    <main class="bg-gray-100">
      <!-- No Address State -->
      <div
        *ngIf="!hasAddresses && !showAddressForm && !showOrderSummaryInDrawer"
        class="max-w-7xl mx-auto px-4 py-8"
      >
        <div class="bg-white rounded-lg shadow-sm p-12 text-center">
          <div class="flex justify-center mb-6">
            <img
              src="assets/img/no location.png"
              class="h-48 w-auto"
              alt="No address"
            />
          </div>

          <h1 class="text-xl font-semibold text-gray-900 mb-3">
            ADD SHIPPING ADDRESS TO CONTINUE
          </h1>
          <p class="text-gray-600 mb-6">
            We're almost there — just need your address details.
          </p>

          <button
            class="bg-[#5a8f69] hover:bg-green-800 text-gray-900 font-medium px-6 py-2 rounded-lg shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            (click)="showAddressForm = true; openr()"
            [disabled]="isTransitioning"
          >
            <span *ngIf="!isTransitioning" class="text-white"
              >ADD NEW SHIPPING ADDRESS</span
            >
            <span *ngIf="isTransitioning" class="button-loader"></span>
          </button>
        </div>
      </div>

      <!-- Has Addresses State -->
      <div
        *ngIf="hasAddresses && !showAddressForm && !showOrderSummaryInDrawer"
        class="max-w-7xl mx-auto px-4 py-6"
      >
        <div class="flex flex-col lg:flex-row gap-6">
          <!-- Left Section - Address Selection -->
          <div class="flex-1">
            <div class="bg-white rounded-lg shadow-sm">
              <!-- Header -->
              <div
                class="border-b border-gray-200 px-3 py-3 flex items-center justify-between"
              >
                <h2 class="text-2xl font-semibold text-gray-900">
                  Select Shipping Address
                </h2>
                <button
                  class="text-sm text-blue-600 hover:text-blue-700 hover:underline flex items-center gap-1"
                  (click)="showAddressForm = true; openr()"
                >
                  <span> + Add New Shipping Address</span>
                </button>
              </div>

              <!-- Address List -->
              <div class="px-3 py-3 max-w-full mx-auto">
                <h3 class="text-base font-semibold text-gray-900 mb-4">
                  Shipping addresses ({{ savedAddresses.length }})
                </h3>

                <div class="space-y-4">
                  <div
                    *ngFor="let address of savedAddresses; let i = index"
                    class="border cursor-pointer transition-all hover:border-gray-400 rounded-lg p-2 mb-2 h-auto md:h-40"
                    [class.border-orange-500]="
                      address.ID === selectedAddress?.ID
                    "
                    [class.bg-orange-50]="address.ID === selectedAddress?.ID"
                    (click)="onSelectAddress(address)"
                  >
                    <div
                      class="flex flex-col sm:flex-row sm:items-start gap-4 sm:gap-2"
                    >
                      <!-- Radio Button -->
                      <div class="pt-0.5 flex-shrink-0">
                        <input
                          type="radio"
                          name="addressSelect"
                          [value]="address"
                          [(ngModel)]="selectedAddress"
                          class="w-4 h-4 text-orange-500 border-gray-300 focus:ring-orange-500"
                        />
                      </div>

                      <!-- Address Content -->
                      <div class="flex-1 min-w-0">
                        <div class="flex flex-wrap items-center gap-2 mb-1">
                          <span class="font-semibold text-gray-900">{{
                            address.NAME
                          }}</span>
                          <span
                            *ngIf="address.IS_DEFAULT"
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-800"
                            >Default</span
                          >
                          <span
                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                            [class.bg-blue-100]="address.ADDRESS_TYPE === 'O'"
                            [class.text-blue-800]="address.ADDRESS_TYPE === 'O'"
                            [class.bg-green-100]="address.ADDRESS_TYPE === 'R'"
                            [class.text-green-800]="
                              address.ADDRESS_TYPE === 'R'
                            "
                          >
                            {{
                              address.ADDRESS_TYPE === "R"
                                ? "Residential"
                                : "Office"
                            }}
                          </span>
                        </div>

                        <p class="text-sm text-gray-700 mb-1 break-words">
                          {{ address.ADDRESS }}
                          <span *ngIf="address.LANDMARK"
                            >, {{ address.LANDMARK }}</span
                          >
                          <br />
                          {{ address.CITY_NAME }}, {{ address.STATE_NAME }},
                          {{ address.PINCODE }}
                        </p>
                        <p class="text-sm text-gray-700 break-words">
                          {{ address.COUNTRY_NAME }}
                        </p>
                        <p class="text-sm text-gray-600 mt-1">
                          {{ address.COUNTRY_CODE }}

                          {{ address.MOBILE_NO }}
                        </p>

                        <!-- Action Links -->
                        <div
                          class="flex flex-wrap items-center gap-4 mt-1 text-sm"
                        >
                          <button
                            class="text-blue-600 hover:text-blue-700 hover:underline"
                            (click)="
                              $event.stopPropagation();
                              openAddressForm(address.ID)
                            "
                          >
                            Edit address
                          </button>
                          <span class="text-gray-300">|</span>
                          <button
                            *ngIf="userId"
                            class="text-blue-600 hover:text-blue-700 hover:underline"
                            (click)="
                              $event.stopPropagation();
                              deleteAddress(address.ID, address.CUST_ID)
                            "
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Use This Address Button -->
                  <!-- <div class="mt-6 pb-4">
                    <button
                      class="bg-[#5a8f69] hover:bg-green-800 text-gray-900 font-medium px-6 py-2 rounded-lg shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-auto"
                      (click)="showOrderSummaryInDrawer = true; steped()"
                      [disabled]="isContinuingToPay || !selectedAddress"
                    >
                      <span *ngIf="!isContinuingToPay" class="text-white"
                        >Use this address</span
                      >
                      <span *ngIf="isContinuingToPay">PROCESSING...</span>
                    </button>
                  </div> -->
                </div>
              </div>
            </div>
          </div>

          <!-- Right Section - Order Summary (Fixed) -->
          <div class="lg:w-80 xl:w-96">
            <div class="bg-white rounded-lg shadow-sm p-6 sticky top-4">
              <div class="border-t border-gray-200 pt-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">
                  Order Summary
                </h3>

                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-700">Items</span>
                    <span class="text-gray-900">
                      {{
                        selectedPrice - selectedDiscount
                          | currency : "USD" : "symbol" : "1.2-2"
                      }}
                    </span>
                  </div>

                  <div class="flex justify-between">
                    <span class="text-gray-700">Delivery</span>
                    <span class="text-gray-900">
                      {{
                        cartDetails?.cartDetails?.[0]?.["DATA"].NET_AMOUNT -
                          cartDetails?.cartDetails?.[0]?.["DATA"]
                            .TOTAL_DISCOUNT_AMOUNT
                          | currency : "USD" : "symbol" : "1.2-2"
                      }}
                    </span>
                  </div>
                </div>

                <div class="border-t border-gray-200 my-3"></div>

                <div class="flex justify-between items-center">
                  <span class="text-lg font-semibold text-red-700"
                    >Order Total</span
                  >
                  <span class="text-lg font-semibold text-red-700">
                    {{
                      selectedPrice -
                        selectedDiscount +
                        (cartDetails?.cartDetails?.[0]?.["DATA"].NET_AMOUNT -
                          cartDetails?.cartDetails?.[0]?.["DATA"]
                            .TOTAL_DISCOUNT_AMOUNT)
                        | number : "1.2-2"
                        | currency : "USD"
                    }}
                  </span>
                </div>
              </div>

              <div class="mt-4 p-3 bg-blue-50 rounded text-xs text-gray-700">
                <p class="font-semibold mb-1">Note</p>
                <p>
                  Delivery costs are based on the items in your basket and the
                  delivery address.
                </p>
              </div>
              <button
                class="w-full bg-[#5a8f69] hover:bg-green-800 text-gray-900 font-medium px-6 py-2 mt-3 rounded-lg shadow-sm transition-colors mb-4"
                (click)="showOrderSummaryInDrawer = true; steped()"
                [disabled]="!selectedAddress"
              >
                <span class="text-white">Use This Address</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Address Form -->
      <!-- <div *ngIf="showAddressForm" class="max-w-4xl mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-sm">
          
          <div class="border-b border-gray-200 px-6 py-4">
            <button
              class="text-blue-600 hover:text-blue-700 hover:underline flex items-center gap-2 mb-2"
              (click)="showAddressForm = false"
            >
              <span>←</span>
              <span>Back to address selection</span>
            </button>
            <h2 class="text-xl font-semibold text-gray-900">
              {{ isEditingAddress ? "Edit Address" : "Add a new address" }}
            </h2>
          </div>

          
          <div class="px-6 py-6">
            <form
              #addressFormTemp="ngForm"
              (ngSubmit)="saveAddress(addressFormTemp)"
              class="space-y-6"
            >
              
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Contact Details
                </h3>

                <div class="space-y-4">
                  <div>
                    <label
                      for="fullName"
                      class="block text-sm font-medium text-gray-700 mb-1"
                    >
                      Full name (First and Last name)
                    </label>
                    <input
                      type="text"
                      id="fullName"
                      [(ngModel)]="addressForm.NAME"
                      name="customerName"
                      placeholder="Enter name"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                    />
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label
                        for="mobileNumber"
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        Mobile number
                      </label>
                      <input
                        type="tel"
                        id="mobileNumber"
                        [(ngModel)]="addressForm.MOBILE_NO"
                        name="mobileNumber"
                        placeholder="Enter Mobile no"
                        (keypress)="commonFunction.omitwithminus($event)"
                        maxlength="12"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                      />
                      <p class="mt-1 text-xs text-gray-500">
                        May be used to assist delivery
                      </p>
                    </div>

                    <div>
                      <label
                        for="emailId"
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        Email
                      </label>
                      <div class="flex gap-2">
                        <input
                          type="text"
                          id="emailId"
                          [(ngModel)]="addressForm.EMAIL_ID"
                          name="Email"
                          placeholder="Enter Email"
                          maxlength="50"
                          [pattern]="commonFunction.emailpattern"
                          required
                          class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                        />
                        <button
                          type="button"
                          class="px-4 py-2 bg-[#5a8f69] hover:bg-green-800 rounded-md text-white disabled:opacity-50 text-sm font-medium"
                          (click)="verifyEmail(); $event.stopPropagation()"
                          [disabled]="
                            !isEmailValid() || verificationStatus == 'verified'
                          "
                        >
                          {{
                            verificationStatus === "verified"
                              ? "✓ Verified"
                              : "Verify"
                          }}
                        </button>
                      </div>
                      <small
                        *ngIf="verificationStatus === 'verified'"
                        class="block mt-1 text-xs text-green-600"
                      >
                        Email verified successfully!
                      </small>
                      <small
                        *ngIf="verificationStatus === 'failed'"
                        class="block mt-1 text-xs text-red-600"
                      >
                        Verification failed. Please try again.
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              
              <div class="border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Address
                </h3>

                <div class="space-y-4">
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Address Type
                    </label>
                    <div class="flex gap-4">
                      <label class="flex items-center cursor-pointer">
                        <input
                          type="radio"
                          name="addressType"
                          value="R"
                          [(ngModel)]="addressForm.ADDRESS_TYPE"
                          class="w-4 h-4 text-orange-500 border-gray-300 focus:ring-orange-500"
                        />
                        <span class="ml-2 text-sm text-gray-700"
                          >Residential</span
                        >
                      </label>
                      <label class="flex items-center cursor-pointer">
                        <input
                          type="radio"
                          name="addressType"
                          value="O"
                          [(ngModel)]="addressForm.ADDRESS_TYPE"
                          class="w-4 h-4 text-orange-500 border-gray-300 focus:ring-orange-500"
                        />
                        <span class="ml-2 text-sm text-gray-700">Office</span>
                      </label>
                    </div>
                  </div>

                  
                  <div>
                    <label
                      for="streetAddress"
                      class="block text-sm font-medium text-gray-700 mb-1"
                    >
                      Flat, House no., Building, Company, Apartment
                    </label>
                    <input
                      type="text"
                      id="streetAddress"
                      [(ngModel)]="addressForm.ADDRESS"
                      name="streetAddress"
                      placeholder="Enter address"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                    />
                  </div>

                  
                  <div>
                    <label
                      for="landmark"
                      class="block text-sm font-medium text-gray-700 mb-1"
                    >
                      Area, Street, Sector, Village
                    </label>
                    <input
                      type="text"
                      id="landmark"
                      [(ngModel)]="addressForm.LANDMARK"
                      name="landmark"
                      placeholder="E.g. Near station, Hospital"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                    />
                  </div>

                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                      <label
                        for="country"
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        Country/Region
                      </label>
                      <input
                        id="country"
                        type="text"
                        [(ngModel)]="countrySearch"
                        (input)="filterCountries(); onCountryInputChange()"
                        (blur)="onCountryBlur()"
                        name="COUNTRY_NAME"
                        #COUNTRY_NAME="ngModel"
                        placeholder="Select country"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                      />

                      <div
                        *ngIf="
                          filteredCountries.length ||
                          showAddCountryOption ||
                          isLoadingCountries
                        "
                        class="absolute z-10 w-full bg-white border border-gray-300 mt-1 rounded-md shadow-md max-h-48 overflow-y-auto"
                      >
                        <div
                          *ngIf="isLoadingCountries"
                          class="p-3 text-center text-gray-500 text-sm"
                        >
                          Loading countries...
                        </div>

                        <div
                          *ngFor="let c of filteredCountries"
                          (mousedown)="selectCountry(c)"
                          class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"
                        >
                          {{ c.NAME }}
                        </div>
                      </div>
                    </div>

                    <div class="relative">
                      <label
                        for="state"
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        State
                      </label>
                      <input
                        id="state"
                        type="text"
                        [(ngModel)]="stateSearch"
                        (input)="filterStates()"
                        (blur)="onStateBlur()"
                        name="STATE_NAME"
                        #STATE_NAME="ngModel"
                        placeholder="Select state"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                      />

                      <div
                        *ngIf="
                          filteredStates.length ||
                          showAddStateOption ||
                          isLoadingStates
                        "
                        class="absolute z-10 w-full bg-white border border-gray-300 mt-1 rounded-md shadow-md max-h-48 overflow-y-auto"
                      >
                        <div
                          *ngIf="isLoadingStates"
                          class="p-3 text-center text-gray-500 text-sm"
                        >
                          Loading states...
                        </div>

                        <div
                          *ngFor="let s of filteredStates"
                          (mousedown)="selectState(s)"
                          class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"
                        >
                          {{ s.NAME }}
                        </div>
                      </div>
                    </div>
                  </div>

                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                      <label
                        for="city"
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        Town/City
                      </label>
                      <input
                        id="city"
                        type="text"
                        [(ngModel)]="citySearch"
                        (input)="filterCities()"
                        (blur)="onCityBlur()"
                        name="CITY"
                        placeholder="Enter city"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                      />

                      <div
                        *ngIf="
                          filteredCities.length ||
                          showAddCityOption ||
                          isLoadingCities
                        "
                        class="absolute z-10 w-full bg-white border border-gray-300 mt-1 rounded-md shadow-md max-h-48 overflow-y-auto"
                      >
                        <div
                          *ngIf="isLoadingCities"
                          class="p-3 text-center text-gray-500 text-sm"
                        >
                          Loading cities...
                        </div>

                        <div
                          *ngFor="let c of filteredCities"
                          (mousedown)="selectCity(c)"
                          class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"
                        >
                          {{ c.NAME }}
                        </div>
                      </div>
                    </div>

                    <div>
                      <label
                        for="zipcode"
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        Pincode
                      </label>
                      <input
                        type="text"
                        id="zipcode"
                        [(ngModel)]="addressForm.PINCODE"
                        name="pincode"
                        placeholder="6 digits [0-9] PIN code"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                      />
                    </div>
                  </div>

                  
                  <div class="flex items-start">
                    <div class="flex items-center h-5">
                      <input
                        id="isDefault"
                        type="checkbox"
                        name="isDefault"
                        [(ngModel)]="addressForm.IS_DEFAULT"
                        class="w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500"
                      />
                    </div>
                    <div class="ml-3">
                      <label
                        for="isDefault"
                        class="text-sm font-medium text-gray-700"
                      >
                        Make this my default address
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              
              <div class="border-t border-gray-200 pt-6">
                
                <button
                  type="submit"
                  class="bg-[#5a8f69] hover:bg-green-800 text-white font-medium px-8 py-1 rounded-lg shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  [disabled]="isSavingAddress || addressFormTemp.invalid"
                >
                  <span *ngIf="!isSavingAddress" class="text-white"
                    >Use this address</span
                  >
                  <span *ngIf="isSavingAddress" class="text-white"
                    >SAVING...</span
                  >
                </button>

                
                <p
                  *ngIf="
                    verificationStatus !== 'verified' && addressForm.EMAIL_ID
                  "
                  class="mt-2 text-sm text-orange-600 flex items-center gap-1"
                >
                  <i class="ri-alert-line"></i>
                  Email not verified. We recommend verifying your email for
                  order updates.
                </p>
              </div>
            </form>
          </div>
        </div>
      </div> -->
      <!-- Modal Backdrop -->
      <div
        *ngIf="showAddressForm"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
      >
        <div
          class="bg-white rounded-lg shadow-sm w-full max-w-3xl max-h-[900px] overflow-hidden"
          (click)="$event.stopPropagation()"
        >
          <div
            class="flex items-center justify-between p-2 border-b border-gray-200 bg-white sticky top-0 z-10"
          >
            <div class="flex items-center gap-0">
              <button
                class="text-gray-600 hover:text-gray-800 p-1 rounded-full hover:bg-gray-100 transition-colors"
                (click)="closeModal()"
              >
                <span class="text-xl">←</span>
              </button>
              <h2 class="text-lg font-semibold text-gray-900">
                {{
                  isEditingAddress ? "Edit Address" : "Add New Shipping Address"
                }}
              </h2>
            </div>
            <button
              class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition-colors"
              (click)="closeModal()"
            >
              <span class="text-xl">×</span>
            </button>
          </div>

          <div class="overflow-y-scroll max-h-[calc(90vh-100px)] rounded-b-lg">
            <div class="px-4 pb-4">
              <form
                #addressFormTemp="ngForm"
                (ngSubmit)="saveAddress(addressFormTemp)"
                class="space-y-0"
              >
                <div>
                  <h3 class="text-lg font-semibold text-[#5a8f69] mb-2">
                    Contact Details
                  </h3>
                  <div class="space-y-4">
                    <div>
                      <label
                        for="fullName"
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        Full Name
                      </label>
                      <input
                        type="text"
                        id="fullName"
                        [(ngModel)]="addressForm.NAME"
                        name="customerName"
                        placeholder="Enter Name"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#5a8f69] focus:border-[#5a8f69]"
                      />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label
                          for="mobileNumber"
                          class="block text-sm font-medium text-gray-700 mb-1"
                        >
                          Mobile number
                        </label>
                        <div class="flex items-stretch relative">
                          <div class="relative min-w-[5.5rem]">
                            <div
                              class="unique-country-code-selector flex items-center cursor-pointer px-3 h-10 border border-gray-300 rounded-l-md **bg-white** text-sm focus:outline-none w-full **shadow-sm**"
                              (click)="toggleCountryDropdown($event)"
                              aria-label="Country code selector"
                              [ngClass]="{
                                '!border-r-0': !showCountryDropdown,

                                'rounded-r-none': showCountryDropdown
                              }"
                            >
                              <span class="text-gray-700 font-medium">{{
                                addressForm.COUNTRY_CODE || "+1"
                              }}</span>
                              <svg
                                class="ml-auto transform transition-transform"
                                [class.rotate-180]="showCountryDropdown"
                                width="10"
                                height="6"
                                viewBox="0 0 10 6"
                                fill="none"
                              >
                                <path
                                  d="M1 1L5 5L9 1"
                                  stroke="#666"
                                  stroke-width="1.5"
                                />
                              </svg>
                            </div>

                            <div
                              class="absolute z-10 top-full left-0 mt-1 w-80"
                              *ngIf="showCountryDropdown"
                            >
                              <div
                                class="unique-country-dropdown bg-white shadow-lg ring-1 ring-black ring-opacity-5 rounded-md p-2"
                                style="
                                  max-height: 300px;
                                  overflow-y: auto;
                                  min-width: 100%;
                                "
                              >
                                <div class="unique-search-box mb-2">
                                  <input
                                    type="text"
                                    class="w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:ring-[#5a8f69] focus:border-[#5a8f69]"
                                    placeholder="Search country..."
                                    [(ngModel)]="searchQuery"
                                    (input)="filterCountriesd($event)"
                                    (click)="$event.stopPropagation()"
                                    autocomplete="off"
                                    name="searchCountry"
                                  />
                                </div>
                                <div class="unique-country-list">
                                  <div
                                    class="unique-country-item px-3 py-2 cursor-pointer hover:bg-gray-100 rounded-sm text-base"
                                    *ngFor="let country of filteredCountryCodes"
                                    (click)="
                                      selectCountrycode(country.value);
                                      $event.stopPropagation()
                                    "
                                  >
                                    {{ country.label }}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <input
                            type="tel"
                            id="mobileNumber"
                            [(ngModel)]="addressForm.MOBILE_NO"
                            name="Mobile_number"
                            placeholder="Enter Mobile no"
                            (keypress)="commonFunction.omit($event)"
                            [pattern]="commonFunction.internationalmobpattern"
                            maxlength="10"
                            required
                            class="flex-1 px-3 **h-10** border border-gray-300 rounded-r-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#5a8f69] focus:border-[#5a8f69]"
                            [ngClass]="{
                              '!border-l-0 rounded-l-none':
                                !showCountryDropdown,
                              'border-l-0 rounded-l-none': showCountryDropdown
                            }"
                          />
                        </div>
                      </div>

                      <div>
                        <label
                          for="emailId"
                          class="block text-sm font-medium text-gray-700 mb-1"
                        >
                          Email
                        </label>

                        <div class="flex w-full">
                          <input
                            type="text"
                            id="emailId"
                            [(ngModel)]="addressForm.EMAIL_ID"
                            name="Email"
                            placeholder="Enter Email"
                            maxlength="50"
                            [pattern]="commonFunction.emailpattern"
                            required
                            class="flex-1 px-3 py-2 border border-gray-300 border-r-0 rounded-l-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#5a8f69] focus:border-[#5a8f69]"
                            (ngModelChange)="onEmailChange()"
                          />

                          <button
                            *ngIf="addressForm.EMAIL_ID"
                            type="button"
                            class="px-4 py-2 bg-[#5a8f69] hover:bg-green-800 rounded-r-md text-white disabled:opacity-50 text-sm font-medium transition-colors whitespace-nowrap"
                            (click)="verifyEmail(); $event.stopPropagation()"
                            [disabled]="
                              !isEmailValid() ||
                              verificationStatus == 'verified'
                            "
                          >
                            {{
                              verificationStatus === "verified"
                                ? "✓ Verified"
                                : "Verify"
                            }}
                          </button>
                        </div>

                        <small
                          *ngIf="verificationStatus === 'verified'"
                          class="block mt-1 text-xs text-green-600"
                        >
                          Email verified successfully!
                        </small>

                        <small
                          *ngIf="verificationStatus === 'failed'"
                          class="block mt-1 text-xs text-red-600"
                        >
                          Verification failed. Please try again.
                        </small>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="border-gray-200 pt-2">
                  <h3 class="text-lg font-semibold text-[#5a8f69] mb-2">
                    Address
                  </h3>

                  <div class="space-y-4">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Address Type
                      </label>
                      <div class="flex flex-wrap gap-4">
                        <label class="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name="addressType"
                            value="R"
                            [(ngModel)]="addressForm.ADDRESS_TYPE"
                            class="w-4 h-4 text-[#5a8f69] border-gray-300 focus:ring-[#5a8f69]"
                          />
                          <span class="ml-2 text-sm text-gray-700"
                            >Residential</span
                          >
                        </label>
                        <label class="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name="addressType"
                            value="O"
                            [(ngModel)]="addressForm.ADDRESS_TYPE"
                            class="w-4 h-4 text-[#5a8f69] border-gray-300 focus:ring-[#5a8f69]"
                          />
                          <span class="ml-2 text-sm text-gray-700">Office</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                          <input
                            type="radio"
                            name="addressType"
                            value="P"
                            [(ngModel)]="addressForm.ADDRESS_TYPE"
                            class="w-4 h-4 text-[#5a8f69] border-gray-300 focus:ring-[#5a8f69]"
                          />
                          <span class="ml-2 text-sm text-gray-700"
                            >Local Pickup</span
                          >
                        </label>
                      </div>
                    </div>

                    <ng-container *ngIf="addressForm.ADDRESS_TYPE !== 'P'">
                      <div>
                        <label
                          for="streetAddress"
                          class="block text-sm font-medium text-gray-700 mb-1"
                        >
                          Flat, House no., Building, Company, Apartment
                        </label>
                        <textarea
                          type="text"
                          id="streetAddress"
                          [(ngModel)]="addressForm.ADDRESS"
                          name="streetAddress"
                          placeholder="Enter Address"
                          [required]="addressForm.ADDRESS_TYPE !== 'P'"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#5a8f69] focus:border-[#5a8f69]"
                        ></textarea>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label
                            for="landmark"
                            class="block text-sm font-medium text-gray-700 mb-1"
                          >
                            Landmark
                          </label>
                          <input
                            type="text"
                            id="landmark"
                            [(ngModel)]="addressForm.LANDMARK"
                            name="landmark"
                            placeholder="Enter Landmark"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#5a8f69] focus:border-[#5a8f69]"
                          />
                        </div>
                        <div>
                          <label
                            for="area"
                            class="block text-sm font-medium text-gray-700 mb-1"
                          >
                            Area
                          </label>
                          <input
                            type="text"
                            id="area"
                            [(ngModel)]="addressForm.LOCALITY"
                            name="area"
                            placeholder="Enter Area"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#5a8f69] focus:border-[#5a8f69]"
                          />
                        </div>
                      </div>
                    </ng-container>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="relative">
                        <label
                          for="country"
                          class="block text-sm font-medium text-gray-700 mb-1"
                        >
                          Country/Region
                        </label>
                        <input
                          id="country"
                          type="text"
                          [(ngModel)]="countrySearch"
                          (input)="filterCountries(); onCountryInputChange()"
                          (blur)="onCountryBlur()"
                          name="COUNTRY_NAME"
                          #COUNTRY_NAME="ngModel"
                          placeholder="Enter Country/Region"
                          required
                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none"
                        />
                        <div
                          *ngIf="
                            filteredCountries.length ||
                            showAddCountryOption ||
                            isLoadingCountries
                          "
                          class="absolute z-20 w-full bg-white mt-1 rounded-md shadow-md max-h-48 overflow-y-auto"
                        >
                          <div
                            *ngIf="isLoadingCountries"
                            class="p-3 text-center text-gray-500 text-sm"
                          >
                            Loading countries...
                          </div>
                          <div
                            *ngFor="let c of filteredCountries"
                            (mousedown)="selectCountry(c)"
                            class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"
                          >
                            {{ c.NAME }}
                          </div>
                        </div>
                      </div>
                      <div class="relative">
                        <label
                          for="state"
                          class="block text-sm font-medium text-gray-700 mb-1"
                        >
                          State/Province
                        </label>
                        <input
                          id="state"
                          type="text"
                          [(ngModel)]="stateSearch"
                          (input)="filterStates(); onStateInputChange()"
                          (blur)="onStateBlur()"
                          name="STATE_NAME"
                          #STATE_NAME="ngModel"
                          placeholder="Enter State/Province"
                          required
                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none"
                        />
                        <div
                          *ngIf="
                            filteredStates.length ||
                            showAddStateOption ||
                            isLoadingStates
                          "
                          class="absolute z-20 w-full bg-white mt-1 rounded-md shadow-md max-h-48 overflow-y-auto"
                        >
                          <div
                            *ngIf="isLoadingStates"
                            class="p-3 text-center text-gray-500 text-sm"
                          >
                            Loading states...
                          </div>
                          <div
                            *ngFor="let s of filteredStates"
                            (mousedown)="selectState(s)"
                            class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"
                          >
                            {{ s.NAME }}
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div
                        class="relative"
                        [class.md:col-span-2]="addressForm.ADDRESS_TYPE === 'P'"
                      >
                        <label
                          for="city"
                          class="block text-sm font-medium text-gray-700 mb-1"
                        >
                          Town/City
                        </label>
                        <input
                          id="city"
                          type="text"
                          [(ngModel)]="citySearch"
                          (input)="filterCities()"
                          (blur)="onCityBlur()"
                          name="CITY"
                          placeholder="Enter Town/City"
                          required
                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none"
                        />
                        <div
                          *ngIf="
                            filteredCities.length ||
                            showAddCityOption ||
                            isLoadingCities
                          "
                          class="absolute z-20 w-full bg-white mt-1 rounded-md shadow-md max-h-48 overflow-y-auto"
                        >
                          <div
                            *ngIf="isLoadingCities"
                            class="p-3 text-center text-gray-500 text-sm"
                          >
                            Loading cities...
                          </div>
                          <div
                            *ngFor="let c of filteredCities"
                            (mousedown)="selectCity(c)"
                            class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"
                          >
                            {{ c.NAME }}
                          </div>
                        </div>
                        <small
                          *ngIf="addressForm.ADDRESS_TYPE === 'P'"
                          class="block mt-1 text-xs text-gray-500"
                        >
                          Please select your city to find local pickup
                          facilities.
                        </small>
                      </div>

                      <div *ngIf="addressForm.ADDRESS_TYPE !== 'P'">
                        <label
                          for="zipcode"
                          class="block text-sm font-medium text-gray-700 mb-1"
                        >
                          Pincode/ZIP
                        </label>
                        <input
                          type="text"
                          id="zipcode"
                          maxlength="6"
                          [(ngModel)]="addressForm.PINCODE"
                          name="pincode"
                          placeholder="6 digits [0-9] PIN/ZIP code"
                          (keypress)="onlyNumbers($event)"
                          [required]="addressForm.ADDRESS_TYPE !== 'P'"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none"
                        />
                      </div>
                    </div>

                    <ng-container *ngIf="addressForm.ADDRESS_TYPE === 'P'">
                      <div class="space-y-2">
                        <div class="flex items-end gap-4">
                          <div class="flex-1">
                            <label
                              id="pickup-label"
                              class="block text-sm font-medium text-gray-700 mb-1"
                            >
                              Select Pickup Location
                            </label>

                            <div class="relative">
                              <button
                                type="button"
                                (click)="
                                  isPickupDropdownOpen = !isPickupDropdownOpen
                                "
                                class="w-full flex items-center justify-between px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-left focus:outline-none focus:ring-2 focus:ring-[#5a8f69] focus:border-[#5a8f69]"
                                aria-haspopup="listbox"
                                aria-labelledby="pickup-label"
                              >
                                <span
                                  class="block truncate"
                                  [class.text-gray-500]="
                                    !getSelectedPickupLocation()
                                  "
                                >
                                  {{
                                    getSelectedPickupLocation()?.name ||
                                      "Select a location"
                                  }}
                                </span>
                                <svg
                                  class="ml-2 h-5 w-5 text-gray-400 transform transition-transform"
                                  [class.rotate-180]="isPickupDropdownOpen"
                                  xmlns="http://www.w3.org/2000/svg"
                                  viewBox="0 0 20 20"
                                  fill="currentColor"
                                >
                                  <path
                                    fill-rule="evenodd"
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                    clip-rule="evenodd"
                                  />
                                </svg>
                              </button>

                              <div
                                *ngIf="isPickupDropdownOpen"
                                class="absolute z-30 w-full mt-1 bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-y-auto focus:outline-none sm:text-sm"
                              >
                                <div
                                  *ngFor="let loc of pickupLocations"
                                  (mousedown)="selectPickupLocation(loc)"
                                  class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-gray-100"
                                  role="option"
                                >
                                  <span
                                    class="block truncate"
                                    [class.font-semibold]="
                                      loc.id === addressForm.PICKUP_LOCATION_ID
                                    "
                                  >
                                    {{ loc.name }}
                                  </span>
                                  <span class="block text-xs text-gray-500">
                                    {{ loc.address }}
                                  </span>
                                  <span
                                    *ngIf="
                                      loc.id === addressForm.PICKUP_LOCATION_ID
                                    "
                                    class="text-[#5a8f69] absolute inset-y-0 right-0 flex items-center pr-4"
                                  >
                                    <svg
                                      class="h-5 w-5"
                                      xmlns="http://www.w3.org/2000/svg"
                                      viewBox="0 0 20 20"
                                      fill="currentColor"
                                    >
                                      <path
                                        fill-rule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clip-rule="evenodd"
                                      />
                                    </svg>
                                  </span>
                                </div>
                                <div
                                  *ngIf="
                                    pickupLocations.length === 0 &&
                                    !isLoadingPickupLocations
                                  "
                                  class="cursor-default select-none relative py-2 px-3 text-gray-500"
                                >
                                  No locations found.
                                </div>
                              </div>

                              <input
                                type="hidden"
                                name="pickupLocation"
                                [ngModel]="addressForm.PICKUP_LOCATION_ID"
                                [required]="addressForm.ADDRESS_TYPE === 'P'"
                              />
                            </div>
                          </div>

                          <button
                            type="button"
                            (click)="findPickupLocations()"
                            [disabled]="!addressForm.CITY_ID"
                            class="px-4 py-2 h-10 border border-gray-300 text-gray-700 font-medium rounded-lg shadow-sm hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            Find
                          </button>
                        </div>

                        <div
                          *ngIf="isLoadingPickupLocations"
                          class="text-sm text-gray-600"
                        >
                          Loading locations...
                        </div>
                        <div
                          *ngIf="
                            showPickupError &&
                            !isLoadingPickupLocations &&
                            pickupLocations.length === 0
                          "
                          class="text-sm text-red-600"
                        >
                          No pickup locations found for the selected city.
                        </div>
                      </div>
                    </ng-container>

                    <ng-container *ngIf="addressForm.ADDRESS_TYPE !== 'P'">
                      <div class="flex items-start">
                        <div class="flex items-center h-5">
                          <input
                            id="isDefault"
                            type="checkbox"
                            name="isDefault"
                            [(ngModel)]="addressForm.IS_DEFUALT_ADDRESS"
                            class="w-4 h-4 text-[#5a8f69] border-gray-300 rounded focus:ring-[#5a8f69]"
                          />
                        </div>
                        <div class="ml-3">
                          <label
                            for="isDefault"
                            class="text-sm font-medium text-gray-700"
                          >
                            Make this my default address
                          </label>
                        </div>
                      </div>
                    </ng-container>

                  </div>
                </div>

                <div
                  class="border-t border-gray-200 pt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
                >
                  <div class="flex-1">
                    <p
                      *ngIf="
                        verificationStatus !== 'verified' &&
                        addressForm.EMAIL_ID
                      "
                      class="text-sm text-orange-600 flex items-center gap-1"
                    >
                      <i class="ri-alert-line"></i>
                      Email not verified. We recommend verifying your email for
                      order updates.
                    </p>
                  </div>
                  <div class="flex gap-3">
                    <button
                      type="button"
                      class="px-6 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg shadow-sm hover:bg-gray-50 transition-colors"
                      (click)="closeModal()"
                    >
                      Cancel
                    </button>
                    <button
                      *ngIf="
                        verificationStatus === 'verified' &&
                        addressForm.EMAIL_ID
                      "
                      type="submit"
                      class="bg-[#5a8f69] hover:bg-green-800 text-white font-medium px-6 py-2 rounded-lg shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                      [disabled]="isSavingAddress || addressFormTemp.invalid"
                    >
                      <span *ngIf="!isSavingAddress">Use This Address</span>
                      <span *ngIf="isSavingAddress">SAVING...</span>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- Order Summary Page -->
      <div
        *ngIf="showOrderSummaryInDrawer"
        class="w-full max-w-7xl mx-auto px-3 sm:px-4 py-4 sm:py-6"
      >
        <div class="flex flex-col lg:flex-row gap-6">
          <!-- Left Section -->
          <div class="flex-1 min-w-0">
            <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6">
              <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4">
                Review items and delivery details
              </h2>

              <!-- Address Card -->
              <div
                class="border border-gray-200 rounded-lg p-3 sm:p-4 mb-5 bg-gray-50"
              >
                <div
                  class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3"
                >
                  <div class="text-sm text-gray-800 break-words">
                    <h3 class="font-semibold text-gray-900">
                      Delivery Address
                    </h3>
                    <p class="font-medium">{{ selectedAddress?.NAME }}</p>
                    <p>
                      {{ selectedAddress?.ADDRESS }},
                      {{ selectedAddress?.CITY_NAME }},
                      {{ selectedAddress?.STATE_NAME }}
                      {{ selectedAddress?.PINCODE }}
                    </p>
                    <p>{{ selectedAddress?.COUNTRY_NAME }}</p>
                    <p>{{ selectedAddress?.MOBILE_NO }}</p>
                  </div>

                  <button
                    class="text-sm text-blue-600 hover:text-blue-700 underline self-start sm:self-auto"
                    (click)="showOrderSummaryInDrawer = false"
                  >
                    Change
                  </button>
                </div>
              </div>

              <!-- Cart Items -->
              <div class="space-y-4">
                <div
                  *ngFor="let item of cartDetails.cartDetails"
                  class="flex gap-4 pb-4 border-b border-gray-200"
                >
                  <ng-container
                    *ngIf="initImageIndex(item.ID) === undefined"
                  ></ng-container>
                  <img
                    [src]="
                      photoURL + getImageArray(item)[imageIndices[item.ID]]
                    "
                    alt="{{ item.PRODUCT_NAME }}"
                    class="w-24 h-24 object-cover rounded"
                  />

                  <div class="flex-1 min-w-0">
                    <h4
                      class="font-semibold text-gray-900 text-base leading-tight"
                    >
                      {{ item.PRODUCT_NAME }}
                    </h4>
                    <p class="text-sm text-gray-600 mt-1">
                      {{ item.CATEGORY_NAME }} {{ item.VERIENT_SIZE }}
                      {{ item.PRODUCT_UNIT_NAME }}
                    </p>
                    <p class="text-sm text-gray-900 font-semibold mt-1">
                      ${{
                        item.DISCOUNT_TYPE == "Amount"
                          ? item.ITEM_DISCOUNT_AMOUNT == 0
                            ? item.VERIENT_RATE
                            : (item.ITEM_DISCOUNT_AMOUNT / item.QUANTITY
                              | number : "1.2-2")
                          : item.DISCOUNT_TYPE == "Percentage"
                          ? (item.VERIENT_RATE -
                              (item.VERIENT_RATE * item.DISCOUNT) / 100
                            | number : "1.2-2")
                          : item.VERIENT_RATE
                      }}
                      ×
                      {{ item.QUANTITY }}
                      <span
                        class="text-sm text-gray-900 font-semibold mt-1 float-end"
                      >
                        Total Price $
                        {{
                          item.DISCOUNT_TYPE == "Amount"
                            ? item.ITEM_DISCOUNT_AMOUNT == 0
                              ? item.VERIENT_RATE * item.QUANTITY
                              : item.ITEM_DISCOUNT_AMOUNT
                            : item.DISCOUNT_TYPE == "Percentage"
                            ? (item.VERIENT_RATE -
                                (item.VERIENT_RATE * item.DISCOUNT) / 100) *
                              item.QUANTITY
                            : item.VERIENT_RATE * item.QUANTITY
                        }}
                      </span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Section (Order Summary) -->
          <div class="w-full lg:w-80 xl:w-96">
            <div
              class="bg-white rounded-xl shadow-sm p-4 sm:p-6 mt-4 lg:mt-0 border border-gray-100 lg:sticky lg:top-4"
            >
              <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3">
                Order Summary
              </h3>

              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-700">Items</span>
                  <span class="text-gray-900">
                    {{
                      selectedPrice - selectedDiscount
                        | number : "1.2-2"
                        | currency : "USD"
                    }}
                  </span>
                </div>

                <div class="flex justify-between">
                  <span class="text-gray-700">Shipping & handling:</span>
                  <span class="text-gray-900">
                    {{
                      cartDetails?.cartDetails?.[0]?.["DATA"].NET_AMOUNT -
                        cartDetails?.cartDetails?.[0]?.["DATA"].TOTAL_DISCOUNT_AMOUNT
                        | currency : "USD" : "symbol" : "1.2-2"
                    }}
                  </span>
                </div>
              </div>

              <div class="border-t border-gray-200 my-3"></div>

              <div class="flex justify-between items-center mb-3">
                <span class="text-base font-semibold text-gray-900">
                  Order total:
                </span>

                <span class="text-lg font-semibold text-red-700">
                  {{
                    selectedPrice -
                      selectedDiscount +
                      (cartDetails?.cartDetails?.[0]?.["DATA"].NET_AMOUNT -
                        cartDetails?.cartDetails?.[0]?.["DATA"]
                          .TOTAL_DISCOUNT_AMOUNT)
                      | number : "1.2-2"
                      | currency : "USD"
                  }}
                </span>
              </div>

              <div
                class="mt-3 p-3 bg-blue-50 rounded text-xs text-gray-700 leading-snug"
              >
                <p class="font-semibold mb-1">Note</p>
                <p>
                  Delivery costs are based on the items in your basket and the
                  delivery address.
                </p>
              </div>

              <button
                class="w-full bg-[#5a8f69] hover:bg-green-800 text-white font-medium px-5 py-2 mt-4 rounded-lg shadow-sm transition-colors"
                (click)="proceedToPayment()"
              >
                Proceed To Payment
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
<div class="modal-backdrop" *ngIf="visible" (click)="dismiss()"></div>

<div class="modal-container" *ngIf="visible">
  <div class="modal-header">
    <button class="close-btn" (click)="dismiss()">×</button>
  </div>

  <div class="otp-content">
    <h2>Enter Verification Code</h2>
    <p class="verification-text">
      We've sent a 4-digit verification code to<br />
      <span class="phone-number">{{ selectedAddress?.EMAIL_ID }}</span>
      &nbsp;<span (click)="dismiss()">
        <i class="bi bi-pencil-square"></i>
      </span>
    </p>

    <div style="color: red; margin-bottom: 15px" *ngIf="statusCode != ''">
      {{ statusCode }}
    </div>

    <form (ngSubmit)="VerifyOTP()" class="otp-form">
      <div class="otp-input-group">
        <input
          *ngFor="let i of [0, 1, 2, 3]; let last = last"
          class="otp-input"
          type="text"
          [(ngModel)]="otp[i]"
          [name]="'otp-' + i"
          maxlength="1"
          (keydown)="moveToNext($event, i)"
          (keypress)="allowOnlyNumbers($event)"
          (ngModelChange)="onChange($event, i)"
          (paste)="handlePaste($event)"
          required
          autocomplete="off"
        />
      </div>

      <div class="timer-section">
        <span *ngIf="remainingTime > 0" class="timer-display"
          >{{ remainingTime }}s</span
        >
        <p class="resend-text">
          Didn’t receive the code?
          <a
            (click)="resendOtp()"
            [ngStyle]="{
              cursor: remainingTime > 0 ? 'default' : 'pointer',
              color: remainingTime > 0 ? '#636363' : '#5a8f69'
            }"
            [class.disabled]="remainingTime > 0"
            >Resend</a
          >
        </p>
      </div>

      <button
        type="submit"
        class="verify-button"
        [disabled]="isverifyOTP || otp.join('').length < 4"
      >
        <span
          *ngIf="isverifyOTP"
          class="spinner-border spinner-border-sm me-2"
        ></span>
        Verify
      </button>
    </form>
  </div>
</div>
<!-- <div
    class="bg-white h-full w-full max-w-lg p-4 text-left shadow-sm text-sm transform transition-transform duration-300 ease-out flex flex-col"
    [class.translate-x-0]="addressDrawerOpen"
    [class.translate-x-full]="!addressDrawerOpen"
    (click)="$event.stopPropagation()"
  >
    <div class="flex justify-end">
      <button
        (click)="closeAddressDrawer()"
        class="text-gray-500 hover:text-gray-700"
      >
        <i class="ri-close-line text-2xl"></i>
      </button>
    </div>
    <div class="flex justify-between items-center mb-4"></div>
    <div class="flex items-center justify-between mb-8 relative">
      <div class="flex flex-col items-center">
        <div
          class="relative w-10 h-10 rounded-full flex items-center justify-center font-bold"
          [ngClass]="
            currentStep > 1
              ? 'bg-green-700 text-white'
              : 'bg-gray-300 text-gray-600'
          "
          (click)="goBackToCart()"
        >
          <span *ngIf="currentStep > 1">✔</span>
          <span *ngIf="currentStep <= 1" (click)="goBackToCart()">1</span>
        </div>
        <p class="text-xs mt-2 text-gray-700 font-medium">Cart Details</p>
      </div>

      <div
        [ngClass]="currentStep > 1 ? 'bg-green-700' : 'bg-gray-300'"
        class="flex-1 h-1 mx-2"
      ></div>
      <div class="flex flex-col items-center">
        <div
          class="relative w-10 h-10 rounded-full flex items-center justify-center font-bold"
          [ngClass]="
            currentStep > 2
              ? 'bg-green-700 text-white'
              : currentStep === 2
              ? 'bg-green-700 text-white'
              : 'bg-gray-300 text-gray-600'
          "
        >
          <span *ngIf="currentStep > 2" (click)="openr()">✔</span>
          <span *ngIf="currentStep <= 2" (click)="openr()">2</span>
        </div>
        <p class="text-xs mt-2 text-gray-700 font-medium" (click)="openr()">
          Address Details
        </p>
      </div>

      <div
        [ngClass]="currentStep > 2 ? 'bg-green-700' : 'bg-gray-300'"
        class="flex-1 h-1 mx-2"
      ></div>
      <div class="flex flex-col items-center">
        <div
          class="relative w-10 h-10 rounded-full flex items-center justify-center font-bold"
          [ngClass]="
            currentStep > 3
              ? 'bg-green-700 text-white'
              : currentStep === 3
              ? 'bg-green-700 text-white'
              : 'bg-gray-300 text-gray-600'
          "
        >
          <span *ngIf="currentStep > 3">✔</span>
          <span *ngIf="currentStep <= 3">3</span>
        </div>
        <p class="text-xs mt-2 text-gray-700 font-medium">Payment Details</p>
      </div>
    </div>
    <div
      class="flex justify-between items-center pb-4 mb-4 border-b border-gray-200"
    >
      <h2
        *ngIf="!showAddressForm && !showOrderSummaryInDrawer"
        class="text-xl font-semibold text-gray-800"
      >
        Choose Shipping Address
      </h2>
    </div>

    <div
      *ngIf="!showAddressForm && !showOrderSummaryInDrawer"
      class="flex-grow overflow-y-auto"
    >
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
          <i class="ri-map-pin-line text-[#5a8f69] text-xl mr-2"></i>
          Your Shopping Addresses
        </h3>

        <button
          class="bg-[#5a8f69] text-white px-4 py-2 text-sm rounded hover:bg-[#5a8f69]/90 transition"
          (click)="openAddressForm(null)"
        >
          + Add New Address
        </button>
      </div>
      <div
        *ngIf="savedAddresses.length < 1"
        style="text-align: center; margin-top: 160px"
      >
        <p class="text-green-800 font-bold text-2xl">No any address added !</p>
        <p class="text-green-800 font-semibold">Please add an address first</p>
      </div>
      <div
        *ngIf="savedAddresses.length > 0"
        class="grid grid-cols-1 gap-6 ml-2 mr-2"
      >
        <div
          *ngFor="let address of savedAddresses"
          class="border border-gray-200 rounded-lg p-4 bg-white relative hover:shadow-md transition-shadow duration-200 cursor-pointer"
          [class.ring-2]="selectedAddress?.ID === address.ID"
          [class.ring-[#5a8f69]]="selectedAddress?.ID === address.ID"
          (click)="onSelectAddress(address)"
        >
          <div class="flex justify-between items-start">
            <div>
              <p class="font-semibold text-gray-800">{{ address.NAME }}</p>
              <p class="text-sm text-gray-600 mt-1">
                {{ address.ADDRESS }}<br />
                {{ address.CITY_NAME }}, {{ address.PINCODE }}
              </p>
              <p class="text-sm text-gray-600 mt-1">
                {{ address.MOBILE_NO }}
              </p>

              <span
                *ngIf="address.ADDRESS_TYPE"
                class="inline-block text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded mt-2 ml-1"
                >{{
                  address.ADDRESS_TYPE == "Residential" ? "Residence" : "Office"
                }}</span
              >
              <span
                *ngIf="address.IS_DEFAULT"
                class="inline-block text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded mt-2"
                >Default
              </span>
            </div>
            <div
              class="space-x-2 flex items-start"
              style="
                display: flex;
                justify-content: center;
                align-items: center;
              "
            >
              <button
                class="text-gray-500 hover:text-[#5a8f69] transition"
                title="Edit"
                (click)="openAddressForm(address.ID); $event.stopPropagation()"
              >
                <i class="ri-edit-2-line"></i>
              </button>
              <input
                type="radio"
                name="selectedAddress"
                [value]="address"
                [(ngModel)]="selectedAddress"
                (click)="$event.stopPropagation()"
                (ngModelChange)="onSelectAddress($event)"
              />

              <button
                class="text-gray-500 hover:text-red-500 transition"
                title="Delete"
                (click)="deleteAddress(address.ID, address.CUST_ID)"
              >
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        *ngIf="selectedAddress"
        class="fixed bottom-0 left-0 right-0 bg-white py-3 px-4 shadow-md text-right"
      >
        <button
          (click)="showOrderSummaryInDrawer = true; steped()"
          class="bg-[#5a8f69] text-white px-6 py-2 rounded-md text-sm hover:bg-[#4a7a58] transition"
        >
          Continue to Pay..
        </button>
      </div>
    </div>
    <div
      *ngIf="showOrderSummaryInDrawer && !showAddressForm"
      class="flex-grow overflow-y-auto"
    >
      <div class="relative">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">Order Summary</h3>

        <div class="text-sm text-gray-700 mb-4">
          <p><strong>Shipping to:</strong> {{ selectedAddress?.NAME }}</p>
          <p class="mt-1">
            {{ selectedAddress?.ADDRESS }}, {{ selectedAddress?.CITY }} -
            {{ selectedAddress?.PINCODE }}
          </p>
        </div>

        <div class="border-t border-gray-200 pt-2 mt-2">
          <h4 class="font-medium mb-2">Items:</h4>
          <ul class="max-h-48 overflow-y-auto text-sm">
            <li *ngFor="let item of cartDetails.cartDetails" class="mb-1">
              {{ item.PRODUCT_NAME }} x {{ item.QUANTITY }} -
              {{ item.PRICE * item.QUANTITY | currency : "USD" }}
            </li>
          </ul>
        </div>

        <div class="border-t border-gray-200 pt-4 mt-4 text-sm space-y-2">
          <div class="flex justify-between gap-4">
            <span class="font-semibold text-gray-700">Price :</span>
            <span class="text-gray-900">{{
              (cartDetails.cartDetails[0].TOTAL_PRICE
                ? cartDetails.cartDetails[0].TOTAL_PRICE
                : 0
              ) | currency : "USD" : "symbol" : "1.2-2"
            }}</span>
          </div>
          <div class="flex justify-between gap-4">
            <span class="font-semibold text-gray-700"
              >Shipping and Handling Charges :</span
            >
            <span class="text-gray-900">
              {{
                cartDetails.cartDetails[0].NET_AMOUNT -
                  cartDetails.cartDetails[0].TOTAL_PRICE || 0
                  | currency : "USD" : "symbol" : "1.2-2"
              }}
            </span>
          </div>
          <div class="flex justify-between gap-4">
            <span class="font-semibold text-green-600">Total Amount :</span>
            <span class="text-green-600 font-semibold">{{
              (cartDetails.cartDetails[0].NET_AMOUNT
                ? cartDetails.cartDetails[0].NET_AMOUNT
                : 0
              ) | currency : "USD" : "symbol" : "1.2-2"
            }}</span>
          </div>
        </div>

        <div
          class="fixed bottom-0 left-0 right-0 bg-white py-3 px-4 shadow-md text-right"
        >
          <button
            (click)="proceedToPayment()"
            class="bg-[#5a8f69] text-white px-6 py-2 rounded-md text-sm hover:bg-[#4a7a58] transition"
          >
            Proceed to Pay
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="showAddressForm" class="flex-grow overflow-y-auto">
      <h3 class="text-lg font-semibold mb-4">
        {{ isEditingAddress ? "Edit Address" : "Add New Address" }}
      </h3>
      <form #form="ngForm" (ngSubmit)="saveAddress(form)" class="mr-2 ml-2">
        <div class="flex-1 mb-4">
          <label class="block mb-1 font-medium">* Address Type</label>
          <div>
            <label class="mr-2">
              <input
                type="radio"
                [(ngModel)]="addressForm.ADDRESS_TYPE"
                name="ADDRESS_TYPE"
                value="R"
                #ADDRESS_TYPE="ngModel"
                required
              />
              Residential
            </label>
            <label>
              <input
                type="radio"
                [(ngModel)]="addressForm.ADDRESS_TYPE"
                name="ADDRESS_TYPE"
                value="O"
                required
              />
              Office
            </label>
          </div>

          <p
            *ngIf="
              ADDRESS_TYPE.invalid && (ADDRESS_TYPE.touched || form.submitted)
            "
            class="text-red-500 text-xs mt-1"
          >
            Address Type is required.
          </p>
        </div>
        <div class="mb-2">
          <label class="block mb-1 font-medium">* Full Name</label>
          <input
            type="text"
            [(ngModel)]="addressForm.NAME"
            name="NAME"
            #NAME="ngModel"
            class="w-full border rounded px-2 py-1 text-sm"
            placeholder="Enter Full Name"
            required
          />
          <p
            *ngIf="NAME.invalid && (NAME.touched || form.submitted)"
            class="text-red-500 text-xs mt-1"
          >
            Full Name is required.
          </p>
        </div>

        <div class="mb-2">
          <label class="block mb-1 font-medium">* Mobile Number</label>
          <input
            type="tel"
            [(ngModel)]="addressForm.MOBILE_NO"
            name="MOBILE_NO"
            #MOBILE_NO="ngModel"
            maxlength="10"
            class="w-full border rounded px-2 py-1 text-sm"
            placeholder="Enter Mobile Number"
            required
            (keypress)="commonFunction.omit($event)"
          />
          <p
            *ngIf="MOBILE_NO.invalid && (MOBILE_NO.touched || form.submitted)"
            class="text-red-500 text-xs mt-1"
          >
            Mobile Number is required.
          </p>
        </div>

        <div class="mb-2">
          <label class="block mb-1 font-medium">* Street Address</label>
          <textarea
            [(ngModel)]="addressForm.ADDRESS"
            name="ADDRESS"
            #ADDRESS="ngModel"
            class="w-full border rounded px-2 py-1 text-sm"
            placeholder="House No., Building, Street, Area"
            required
          ></textarea>
          <p
            *ngIf="ADDRESS.invalid && (ADDRESS.touched || form.submitted)"
            class="text-red-500 text-xs mt-1"
          >
            Address is required.
          </p>
        </div>
        <div class="flex gap-2 mb-2">
          <div class="flex-1">
            <label class="block mb-1 font-medium">Landmark</label>
            <input
              [(ngModel)]="addressForm.LANDMARK"
              name="landmark"
              class="w-full border rounded px-2 py-1 text-sm"
              placeholder="E.g., Near Apollo Hospital"
            />
          </div>
          <div class="flex-1">
            <label class="block mb-1 font-medium">Area</label>
            <input
              [(ngModel)]="addressForm.LOCALITY"
              name="area"
              class="w-full border rounded px-2 py-1 text-sm"
              placeholder="E.g., Bandra West"
            />
          </div>
        </div>

        <div class="flex gap-2 mb-2">
          <div class="flex-1 relative">
            <label class="block mb-1 font-medium">* Country</label>
            <input
              type="text"
              [(ngModel)]="countrySearch"
              (input)="filterCountries(); onCountryInputChange()"
              (blur)="onCountryBlur()"
              name="COUNTRY_NAME"
              #COUNTRY_NAME="ngModel"
              placeholder="Search or add country"
              class="w-full border rounded px-2 py-1 text-sm"
              required
            />

            <div
              *ngIf="
                filteredCountries.length ||
                showAddCountryOption ||
                isLoadingCountries
              "
              class="absolute z-10 bg-white border mt-1 rounded shadow w-full max-h-48 overflow-y-auto"
            >

              <div
                *ngIf="isLoadingCountries"
                class="p-2 text-center text-gray-500 text-sm"
              >
                <i class="ri-loader-4-line animate-spin mr-1"></i> Loading
                countries...
              </div>


              <div
                *ngFor="let c of filteredCountries"
                (mousedown)="selectCountry(c)"
                class="px-2 py-1 hover:bg-gray-100 cursor-pointer"
              >
                {{ c.NAME }}
              </div>


              <div
                *ngIf="showAddCountryOption && !isLoadingCountries"
                (mousedown)="createCountry(countrySearch)"
                class="flex items-center px-2 py-1 text-green-600 hover:bg-gray-100 cursor-pointer border-t"
              >
                <i class="ri-add-circle-line mr-1"></i> Add "{{
                  countrySearch
                }}"
              </div>
            </div>
          </div>


          <div class="flex-1 relative">
            <label class="block mb-1 font-medium">* State</label>
            <input
              type="text"
              [(ngModel)]="stateSearch"
              (input)="filterStates()"
              (blur)="onStateBlur()"
              name="STATE_NAME"
              #STATE_NAME="ngModel"
              placeholder="Search or add state"
              class="w-full border rounded px-2 py-1 text-sm"
              required
            />

            <div
              *ngIf="
                filteredStates.length || showAddStateOption || isLoadingStates
              "
              class="absolute z-10 bg-white border mt-1 rounded shadow w-full max-h-48 overflow-y-auto"
            >

              <div
                *ngIf="isLoadingStates"
                class="p-2 text-center text-gray-500 text-sm"
              >
                <i class="ri-loader-4-line animate-spin mr-1"></i> Loading
                states...
              </div>

              <div
                *ngFor="let s of filteredStates"
                (mousedown)="selectState(s)"
                class="px-2 py-1 hover:bg-gray-100 cursor-pointer"
              >
                {{ s.NAME }}
              </div>

              <div
                *ngIf="showAddStateOption && !isLoadingStates"
                (mousedown)="createState(stateSearch)"
                class="flex items-center px-2 py-1 text-green-600 hover:bg-gray-100 cursor-pointer border-t"
              >
                <i class="ri-add-circle-line mr-1"></i> Add "{{ stateSearch }}"
              </div>
            </div>
          </div>
        </div>

        <div class="flex gap-2 mb-2">
          <div class="flex-1 relative">
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >* City</label
            >
            <input
              type="text"
              [(ngModel)]="citySearch"
              (input)="filterCities()"
              (blur)="onCityBlur()"
              name="CITY"
              placeholder="Search or add city"
              class="w-full border rounded px-2 py-1 text-sm"
            />

            <div
              *ngIf="
                filteredCities.length || showAddCityOption || isLoadingCities
              "
              class="absolute z-10 bg-white border mt-1 rounded shadow w-full max-h-48 overflow-y-auto"
            >

              <div
                *ngIf="isLoadingCities"
                class="p-2 text-center text-gray-500 text-sm"
              >
                <i class="ri-loader-4-line animate-spin mr-1"></i> Loading
                cities...
              </div>

              <div
                *ngFor="let c of filteredCities"
                (mousedown)="selectCity(c)"
                class="px-2 py-1 hover:bg-gray-100 cursor-pointer"
              >
                {{ c.NAME }}
              </div>

              <div
                *ngIf="showAddCityOption && !isLoadingCities"
                (mousedown)="createCity(citySearch)"
                class="flex items-center px-2 py-1 text-green-600 hover:bg-gray-100 cursor-pointer border-t"
              >
                <i class="ri-add-circle-line mr-1"></i> Add "{{ citySearch }}"
              </div>
            </div>
          </div>

          <div class="flex-1">
            <label class="block mb-1 font-medium">* Zipcode</label>
            <input
              [(ngModel)]="addressForm.PINCODE"
              name="PINCODE"
              #PINCODE="ngModel"
              class="w-full border rounded px-2 py-1 text-sm"
              placeholder="Enter Zipcode"
              required
            />
          </div>
        </div>

        <div class="flex gap-2 mb-2 items-center">
          <div class="flex-1 flex items-center">
            <label class="block mb-1 font-medium mr-2"
              >Mark Default Address</label
            >
            <input
              type="checkbox"
              [(ngModel)]="addressForm.IS_DEFAULT"
              name="isDefault"
              (change)="onDefaultAddressChange($event)"
              [checked]="addressForm.IS_DEFAULT"
            />
          </div>
        </div>

        <div class="flex justify-end gap-2 mt-3">
          <button
            type="button"
            (click)="goBackToAddressList()"
            class="bg-gray-200 px-3 py-1.5 rounded text-xs font-medium hover:bg-gray-300 transition"
          >
            Back to List
          </button>
          <button
            type="submit"
            class="bg-[#5a8f69] text-white px-3 py-1.5 rounded text-xs font-medium hover:bg-opacity-90 transition"
          >
            {{ isEditingAddress ? "Update" : "Add" }}
          </button>
        </div>
      </form>
    </div>
  </div> -->
<!-- </div> -->
<div
  *ngIf="showPaymentModal"
  class="fixed inset-0 flex items-center justify-center bg-black/50"
  style="z-index: 1001"
>
  <div class="bg-white p-6 rounded-lg shadow-sm w-full max-w-sm relative">
    <button
      (click)="closePaymentModal()"
      class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
    >
      <i class="ri-close-line text-xl"></i>
    </button>
    <h3 class="text-lg font-semibold mb-4 text-gray-800">
      Complete Your Payment
    </h3>

    <div id="card-container" class="my-4 border rounded p-2">
      <app-common-loader
        *ngIf="isLoadingCard"
        class="overlay-loader"
      ></app-common-loader>
    </div>

    <button
      [disabled]="isProcessingPayment"
      (click)="processPaymentWithToken()"
      class="mt-4 w-full bg-[#5a8f69] text-white py-2 rounded-md hover:bg-[#4a7a58] transition flex items-center justify-center"
    >
      <ng-container *ngIf="isProcessingPayment; else payText">
        <svg
          class="animate-spin h-5 w-5 mr-2 text-white"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
          ></path>
        </svg>
        Processing...
      </ng-container>
      <ng-template #payText>
        Pay &nbsp;
        <span>
          {{
            selectedPrice -
              selectedDiscount +
              (cartDetails?.cartDetails?.[0]?.["DATA"].NET_AMOUNT -
                cartDetails?.cartDetails?.[0]?.["DATA"].TOTAL_DISCOUNT_AMOUNT)
              | number : "1.2-2"
              | currency : "USD"
          }}
        </span>
      </ng-template>
    </button>
  </div>
</div>
<!-- <div id="card-container" class="my-4"></div> -->

<div
  *ngIf="showOrderSummaryModal"
  class="fixed inset-0 flex items-center justify-center bg-black/50 z-50"
>
  <div class="bg-white p-6 rounded-lg shadow-sm w-full max-w-lg relative">
    <button
      (click)="showOrderSummaryModal = false"
      class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
    >
      <i class="ri-close-line text-xl" (click)="desteper()"></i>
    </button>
    <h3 class="text-lg font-semibold mb-4 text-gray-800">Order Summary</h3>

    <div class="text-sm text-gray-700 mb-4">
      <p><strong>Shipping to:</strong> {{ selectedAddress?.NAME }}</p>
      <p class="mt-1">
        {{ selectedAddress?.ADDRESS }}, {{ selectedAddress?.CITY }} -
        {{ selectedAddress?.PINCODE }}
      </p>
    </div>

    <div class="border-t border-gray-200 pt-2 mt-2">
      <h4 class="font-medium mb-2">Items</h4>
      <ul class="max-h-48 overflow-y-auto text-sm">
        <li *ngFor="let item of cartDetails.cartDetails" class="mb-1">
          {{ item.PRODUCT_NAME }} x {{ item.QUANTITY }} -
          {{ item.PRICE * item.QUANTITY | currency : "USD" }}
        </li>
      </ul>
    </div>

    <div class="border-t border-gray-200 text-sm space-y-2 text-right">
      <div class="flex justify-between gap-4">
        <span class="font-semibold text-gray-700">Price </span>
        <span class="text-gray-900">{{
          (cartDetails.cartDetails[0].TOTAL_PRICE
            ? cartDetails.cartDetails[0].TOTAL_PRICE
            : 0
          ) | currency : "USD" : "symbol" : "1.2-2"
        }}</span>
      </div>
      <div class="flex justify-between gap-4">
        <span class="font-semibold text-gray-700"
          >Shipping and Handling Charges</span
        >

        <span class="text-gray-900">
          {{
            cartDetails.cartDetails[0].NET_AMOUNT -
              cartDetails.cartDetails[0].TOTAL_PRICE || 0
              | currency : "USD" : "symbol" : "1.2-2"
          }}
        </span>
      </div>

      <div class="flex justify-between gap-4">
        <span class="font-semibold text-green-600">Total Amount</span>
        <span class="text-green-600 font-semibold">{{
          (cartDetails.cartDetails[0].NET_AMOUNT
            ? cartDetails.cartDetails[0].NET_AMOUNT
            : 0
          ) | currency : "USD" : "symbol" : "1.2-2"
        }}</span>
      </div>
    </div>
    <div class="mt-4 text-right">
      <button
        (click)="proceedToPayment()"
        class="bg-[#5a8f69] text-white px-6 py-2 rounded-md text-sm hover:bg-[#4a7a58] transition"
      >
        Proceed to Pay
      </button>
    </div>
  </div>
</div>

<div
  *ngIf="paymentSuccessModalVisible"
  class="fixed inset-0 flex items-center justify-center bg-black/50"
  style="z-index: 1001"
>
  <div class="bg-white p-6 rounded-lg shadow-sm w-full max-w-sm relative">
    <button
      (click)="paymentSuccessModalVisible = false"
      class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
    >
      <i class="ri-close-line text-xl" (click)="goToProductListing()"></i>
    </button>
    <h3 class="text-lg font-semibold mb-4 text-green-700 flex items-center">
      <i class="ri-check-line text-2xl mr-2"></i>
      Payment Successful!
    </h3>
    <p class="text-sm text-gray-600 mb-4">
      Your order has been placed successfully.
    </p>
    <div class="flex justify-between">
      <button
        *ngIf="userId"
        (click)="goToProfileSection('orders-section'); $event.preventDefault()"
        class="bg-emerald-600 text-white px-4 py-2 rounded-md text-sm"
      >
        View Order Details
      </button>
      <button
        (click)="goToProductListing()"
        class="bg-gray-200 px-4 py-2 rounded-md text-sm hover:bg-gray-300 transition"
      >
        Back to Shop
      </button>
    </div>
  </div>
</div>

<!-- <div
  *ngIf="showReceiptModal"
  class="fixed inset-0 flex items-center justify-center bg-black/40 backdrop-blur-sm"
  style="z-index: 1001"
>
  <div
    class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative p-3 md:p-8 border border-gray-100"
  >
    <button
      (click)="closeReceiptModal()"
      class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition"
    >
      <i class="ri-close-line text-2xl"></i>
    </button>

    <h2
      class="text-center text-lg md:text-xl font-semibold text-gray-800 mb-4 rounded-md py-2"
    >
      Thank you for ordering our
      {{ cartDetails.cartDetails.length > 1 ? "products" : "product" }}!
    </h2>

    <div class="mt-4 border-t border-gray-200 pt-4">
      <div class="flex justify-between text-sm font-medium text-gray-500 mb-2">
        <span>Product</span>
        <span>Price</span>
      </div>

      <ul class="text-sm text-gray-700 divide-y divide-gray-100">
        <li
          *ngFor="let item of cartDetails.cartDetails"
          class="flex justify-between items-center py-3"
        >
          <div class="flex items-center gap-3">
            <img
              *ngIf="getImageArray(item) && getImageArray(item).length"
              [src]="photoURL + getImageArray(item)[imageIndices[item.ID]]"
              alt="{{ item.PRODUCT_NAME }}"
              class="w-10 h-10 rounded-md object-cover border border-gray-200"
            />
            <div>
              <span class="font-medium text-gray-800 block">{{
                item.PRODUCT_NAME
              }}</span>
              <span class="text-gray-500 text-xs"
                >Qty: {{ item.QUANTITY }}</span
              >
            </div>
          </div>

          <span class="text-gray-900 font-medium">
            {{ item.PRICE * item.QUANTITY | currency : "USD" }}
          </span>
        </li>
      </ul>

      <div class="border-t border-gray-200 mt-3 pt-3 text-sm space-y-1">
        <div class="flex justify-between">
          <span class="text-gray-600">Shipping and Handling</span>
          <span class="text-gray-900 font-medium">{{
            cartDetails.cartDetails[0].NET_AMOUNT -
              cartDetails.cartDetails[0].TOTAL_PRICE | currency : "USD"
          }}</span>
        </div>

        <div class="flex justify-between">
          <span class="text-gray-600">Subtotal</span>
          <span class="text-gray-900 font-medium"
            >${{
              cartDetails.cartDetails[0].TOTAL_PRICE | number : "1.2-2"
            }}</span
          >
        </div>

        <div
          class="flex justify-between text-base font-semibold text-gray-800 mt-2"
        >
          <span>Total:</span>
          <span class="text-green-600">{{
            cartDetails.cartDetails[0].NET_AMOUNT | currency : "USD"
          }}</span>
        </div>
      </div>
    </div>

    <div class="mt-4 text-sm text-gray-600 border-t border-gray-200 pt-3">
      <p>
        <strong>Delivery Address:</strong>
        {{ selectedAddress?.NAME }}, {{ selectedAddress?.ADDRESS }},
        {{ selectedAddress?.CITY }} - {{ selectedAddress?.PINCODE }}
      </p>
      <p class="mt-1">
        <strong>Order Date:</strong> {{ today | date : "MM/dd/yyyy" }}
      </p>
    </div>

    <div class="mt-6 text-center">
      <a
        routerLink="/product-list"
        class="text-blue-600 hover:text-blue-800 font-medium underline text-sm"
      >
        Continue Shopping
      </a>
    </div>

    <p class="mt-4 text-center text-xs text-gray-400">
      Any questions? Ask us at
      <a
        href="mailto:ojasvidermacare@gmail.com"
        class="text-blue-500 hover:underline"
        >ojasvidermacare@gmail.com</a
      >
    </p>
  </div>
</div> -->
<!-- <div
  *ngIf="showReceiptModal"
  class="fixed inset-0 flex items-center justify-center bg-gray-50/70 backdrop-blur-sm p-2 md:p-4"
  style="z-index: 1001"
>
  <div
    class="bg-white rounded-xl shadow-2xl w-full max-w-6xl relative p-5 md:p-6 border border-gray-100 grid grid-cols-1 lg:grid-cols-3 gap-5 my-2 max-h-[95vh] overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <div class="lg:col-span-3 flex justify-between items-center mb-3">
      <h2 class="text-xl md:text-2xl font-bold text-gray-800">
        Order Confirmation
      </h2>

      <button
        (click)="closeReceiptModal()"
        class="text-gray-400 hover:text-gray-600 transition"
        aria-label="Close receipt modal"
      >
        <i class="ri-close-line text-2xl"></i>
      </button>
    </div>

    <div class="lg:col-span-2 space-y-5">
      <p class="text-sm text-gray-600 border-b pb-3">
        Thank you for ordering our
        <span class="font-semibold">{{
          cartDetails.cartDetails.length > 1 ? "products" : "product"
        }}</span
        >! Your order has been successfully placed.
      </p>

      <div
        class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm space-y-3"
      >
        <div class="flex justify-between items-center pb-2 border-b">
          <span class="text-lg font-semibold text-gray-800"
            >Product Details</span
          >
        </div>

        <ul class="text-sm text-gray-700 divide-y divide-gray-100">
          <li
            *ngFor="let item of cartDetails.cartDetails"
            class="flex justify-between items-start py-2"
          >
            <div class="flex items-start gap-3 w-2/3">
              <img
                *ngIf="getImageArray(item) && getImageArray(item).length"
                [src]="photoURL + getImageArray(item)[imageIndices[item.ID]]"
                alt="{{ item.PRODUCT_NAME }}"
                class="w-12 h-12 rounded-md object-cover border border-gray-200"
              />
              <div class="flex-grow">
                <span
                  class="font-medium text-gray-800 block text-base leading-tight"
                  >{{ item.PRODUCT_NAME }}</span
                >
                <span class="text-gray-500 text-sm mt-0.5 block"
                  >{{ item.QUANTITY }} Qty</span
                >
                <span class="text-gray-500 text-sm mt-0.5 block"
                  >{{item.VERIENT_SIZE}} {{ item.VERIENT_UNIT_NAME }} Varient</span
                >
              </div>
            </div>

            <span
              class="text-gray-900 font-semibold text-right w-1/3 text-base"
            >
              {{ item.PRICE * item.QUANTITY | currency : "USD" }}
            </span>
          </li>
        </ul>
      </div>

      <div
        class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm space-y-2"
      >
        <span class="text-lg font-semibold text-gray-800">Order Progress</span>
        <div class="space-y-1.5">
          <div class="flex items-center text-base">
            <i class="ri-checkbox-circle-fill text-xl text-green-600 mr-2"></i>
            <span class="font-medium text-gray-800"
              >Order Placed {{ today | date : "MMM dd" }}</span
            >
          </div>

          <div class="flex items-center text-base">
            <i class="ri-checkbox-circle-fill text-xl text-yellow-600 mr-2"></i>
            <span class="font-medium text-gray-800">Shipped</span>
          </div>

          <div class="flex items-center text-base">
            <i class="ri-checkbox-circle-fill text-xl text-yellow-600 mr-2"></i>
            <span class="font-medium text-gray-800">Delivered</span>
          </div>
        </div>
      </div>
    </div>

    <div class="space-y-5">
      <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 space-y-2">
        <h3 class="text-base font-semibold text-gray-800">Delivery Details</h3>

        <div class="flex items-start text-sm text-gray-600 space-x-2">
          <i class="ri-map-pin-2-line text-lg text-yellow-600 mt-0.5"></i>
          <p>
            {{ selectedAddress?.ADDRESS }}, {{ selectedAddress?.CITY }} -
            {{ selectedAddress?.PINCODE }}
          </p>
        </div>

        <div class="flex items-center text-sm text-gray-600 space-x-2">
          <i class="ri-user-line text-lg text-yellow-600"></i>
          <p>{{ selectedAddress?.NAME }}</p>
        </div>
      </div>

      <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 space-y-2">
        <h3 class="text-base font-semibold text-gray-800">Price Details</h3>
        <div class="text-sm space-y-1.5">
          <div class="flex justify-between">
            <span class="text-gray-600">Subtotal</span>
            <span class="text-gray-900 font-medium"
              >${{
                cartDetails.cartDetails[0].TOTAL_PRICE | number : "1.2-2"
              }}</span
            >
          </div>

          <div class="flex justify-between">
            <span class="text-gray-600">Shipping and Handling</span>
            <span class="text-gray-900 font-medium text-yellow-600">{{
              cartDetails.cartDetails[0].NET_AMOUNT -
                cartDetails.cartDetails[0].TOTAL_PRICE | currency : "USD"
            }}</span>
          </div>
        </div>

        <div
          class="flex justify-between border-t border-gray-300 pt-3 text-lg font-bold text-gray-800"
        >
          <span>Total amount:</span>
          <span class="text-green-600">{{
            cartDetails.cartDetails[0].NET_AMOUNT | currency : "USD"
          }}</span>
        </div>
      </div>

      <div class="text-center">
        <button
          class="w-full py-3 bg-[#5a8f69] text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 transition"
          (click)="downloadInvoice()"
          [disabled]="showPaymentModal"
        >
          <i class="ri-file-download-line mr-2"></i> Download Invoice
        </button>
      </div>

      <div class="text-center pt-2">
        <a
          (click)="goToProductListing()"
          class="text-blue-600 hover:text-blue-800 font-medium underline text-sm cursor-pointer"
        >
          Continue Shopping
        </a>
        <p class="mt-3 text-center text-xs text-gray-400">
          Any questions? Ask us at
          <a
            href="mailto:ojasvidermacare@gmail.com"
            class="text-blue-500 hover:underline"
            >ojasvidermacare@gmail.com</a
          >
        </p>
      </div>
    </div>
  </div>
</div> -->
<div
  *ngIf="showReceiptModal"
  class="fixed inset-0 flex items-center justify-center bg-gray-50/70 backdrop-blur-sm p-2 md:p-3"
  style="z-index: 1001"
>
  <div
    class="bg-white rounded-xl shadow-2xl w-full max-w-5xl relative p-3 md:p-4 border border-gray-100 grid grid-cols-1 lg:grid-cols-3 gap-3 max-h-[95vh] overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="lg:col-span-3 flex justify-between items-center mb-2">
      <h2 class="text-lg md:text-xl font-bold text-gray-800">
        Order Confirmation
      </h2>
      <button
        (click)="closeReceiptModal()"
        class="text-gray-400 hover:text-gray-600 transition"
        aria-label="Close receipt modal"
      >
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>

    <!-- Left Section -->
    <div class="lg:col-span-2 space-y-3">
      <p class="text-xs md:text-sm text-gray-600 border-b pb-2">
        Thank you for ordering our
        <span class="font-semibold">{{
          cartDetails.cartDetails.length > 1 ? "products" : "product"
        }}</span
        >! Your order has been successfully placed.
      </p>

      <!-- Product Details -->
      <div
        class="bg-white rounded-lg p-2 border border-gray-200 shadow-sm space-y-2"
      >
        <div class="flex justify-between items-center pb-1 border-b">
          <span class="text-base font-semibold text-gray-800"
            >Product Details</span
          >
        </div>

        <ul class="text-sm text-gray-700 divide-y divide-gray-100">
          <li
            *ngFor="let item of cartDetails.cartDetails"
            class="flex justify-between items-start py-2"
          >
            <div class="flex items-start gap-2 w-2/3">
              <img
                *ngIf="getImageArray(item) && getImageArray(item).length"
                [src]="photoURL + getImageArray(item)[imageIndices[item.ID]]"
                alt="{{ item.PRODUCT_NAME }}"
                class="w-10 h-10 rounded-md object-cover border border-gray-200"
              />
              <div class="flex-grow leading-tight">
                <span class="font-medium text-gray-800 block text-sm">{{
                  item.PRODUCT_NAME
                }}</span>
                <span class="text-gray-500 text-xs block"
                  >{{
                    item.DISCOUNT_TYPE == "Amount"
                      ? item.ITEM_DISCOUNT_AMOUNT == 0
                        ? item.VERIENT_RATE
                        : (item.ITEM_DISCOUNT_AMOUNT / item.QUANTITY
                          | number : "1.2-2")
                      : item.DISCOUNT_TYPE == "Percentage"
                      ? (item.VERIENT_RATE -
                          (item.VERIENT_RATE * item.DISCOUNT) / 100
                        | number : "1.2-2")
                      : item.VERIENT_RATE
                  }}
                  x {{ item.QUANTITY }} Qty</span
                >
                <span class="text-gray-500 text-xs block"
                  >{{ item.VERIENT_SIZE }}
                  {{ item.VERIENT_UNIT_NAME }} Varient</span
                >
              </div>
            </div>

            <span class="text-gray-900 font-semibold text-right w-1/3 text-sm">
              $
              {{
                item.DISCOUNT_TYPE == "Amount"
                  ? item.ITEM_DISCOUNT_AMOUNT == 0
                    ? item.VERIENT_RATE * item.QUANTITY
                    : item.ITEM_DISCOUNT_AMOUNT
                  : item.DISCOUNT_TYPE == "Percentage"
                  ? (item.VERIENT_RATE -
                      (item.VERIENT_RATE * item.DISCOUNT) / 100) *
                    item.QUANTITY
                  : item.VERIENT_RATE * item.QUANTITY
              }}
            </span>
          </li>
        </ul>
      </div>

      <!-- Order Progress -->
      <div
        class="bg-white rounded-lg p-2 border border-gray-200 shadow-sm space-y-2"
      >
        <span class="text-base font-semibold text-gray-800"
          >Order Progress</span
        >

        <div class="flex items-center justify-between text-center pt-3">
          <!-- Step 1 -->
          <div class="flex flex-col items-center">
            <div
              class="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold transition-colors duration-300"
              [ngClass]="{
                'bg-green-500': orderStatus !== 'A' && orderStatus !== 'DC',
                'bg-yellow-500': orderStatus === 'A',
                'bg-gray-400': orderStatus === 'DC'
              }"
            >
              <i
                *ngIf="orderStatus !== 'A' && orderStatus !== 'DC'"
                class="ri-check-line text-sm"
              ></i>
              <span *ngIf="orderStatus === 'A' || orderStatus === 'DC'">1</span>
            </div>
            <span class="text-[11px] mt-1 text-gray-800 font-medium"
              >Placed</span
            >
          </div>

          <div
            class="h-1 mx-1 flex-1"
            [ngClass]="{
              'bg-green-500': orderStatus !== 'A' && orderStatus !== 'DC',
              'bg-gray-200': orderStatus === 'A' || orderStatus === 'DC'
            }"
            style="margin-top: -20px"
          ></div>

          <!-- Step 2 -->
          <div class="flex flex-col items-center">
            <div
              class="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold transition-colors duration-300"
              [ngClass]="{
                'bg-green-500': isStatusComplete(orderStatus, 'D'),
                'bg-yellow-500': orderStatus === 'BP' || orderStatus === 'SP',
                'bg-gray-400':
                  isStatusPending(orderStatus, 'BP') || orderStatus === 'DC'
              }"
            >
              <i
                *ngIf="isStatusComplete(orderStatus, 'D')"
                class="ri-check-line text-sm"
              ></i>
              <span *ngIf="!isStatusComplete(orderStatus, 'D')">2</span>
            </div>
            <span class="text-[11px] mt-1 text-gray-800 font-medium"
              >Preparing</span
            >
          </div>

          <div
            class="h-1 mx-1 flex-1"
            [ngClass]="{
              'bg-green-500': isStatusComplete(orderStatus, 'D'),
              'bg-gray-200': isStatusPending(orderStatus, 'D')
            }"
            style="margin-top: -20px"
          ></div>

          <!-- Step 3 -->
          <div class="flex flex-col items-center">
            <div
              class="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold transition-colors duration-300"
              [ngClass]="{
                'bg-green-500': isStatusComplete(orderStatus, 'DD'),
                'bg-yellow-500': orderStatus === 'D',
                'bg-gray-400':
                  isStatusPending(orderStatus, 'D') || orderStatus === 'DC'
              }"
            >
              <i
                *ngIf="isStatusComplete(orderStatus, 'DD')"
                class="ri-check-line text-sm"
              ></i>
              <span *ngIf="!isStatusComplete(orderStatus, 'DD')">3</span>
            </div>
            <span class="text-[11px] mt-1 text-gray-800 font-medium"
              >Shipped</span
            >
          </div>

          <div
            class="h-1 mx-1 flex-1"
            [ngClass]="{
              'bg-green-500': orderStatus === 'DD',
              'bg-gray-200': orderStatus !== 'DD'
            }"
            style="margin-top: -20px"
          ></div>

          <!-- Step 4 -->
          <div class="flex flex-col items-center">
            <div
              class="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold transition-colors duration-300"
              [ngClass]="{
                'bg-green-500': orderStatus === 'DD',
                'bg-gray-400': orderStatus !== 'DD' && orderStatus !== 'DC'
              }"
            >
              <i *ngIf="orderStatus === 'DD'" class="ri-check-line text-sm"></i>
              <span *ngIf="orderStatus !== 'DD'">4</span>
            </div>
            <span class="text-[11px] mt-1 text-gray-800 font-medium"
              >Delivered</span
            >
          </div>
        </div>

        <div *ngIf="orderStatus === 'DC'" class="text-center pt-2">
          <span class="text-sm font-bold text-red-600">Order Canceled</span>
        </div>
      </div>
    </div>

    <!-- Right Section -->
    <div class="space-y-3">
      <!-- Delivery -->
      <div class="bg-gray-50 rounded-lg p-2 border border-gray-200 space-y-1.5">
        <h3 class="text-sm font-semibold text-gray-800">Delivery Details</h3>
        <div class="flex items-center text-xs text-gray-600 space-x-2">
          <i class="ri-user-line text-base text-yellow-600"></i>
          <p>{{ selectedAddress?.NAME }}</p>
        </div>
        <div class="flex items-start text-xs text-gray-600 space-x-2">
          <i class="ri-map-pin-2-line text-base text-yellow-600 mt-0.5"></i>
          <p>
            {{ selectedAddress?.ADDRESS }}, {{ selectedAddress?.CITY }},
            {{ selectedAddress?.STATE_NAME }},
            {{ selectedAddress?.COUNTRY_NAME }} -
            {{ selectedAddress?.PINCODE }}
          </p>
        </div>
      </div>

      <!-- Price -->
      <div class="bg-gray-50 rounded-lg p-2 border border-gray-200 space-y-1.5">
        <h3 class="text-sm font-semibold text-gray-800">Price Details</h3>
        <div class="text-xs space-y-1">
          <div class="flex justify-between">
            <span class="text-gray-600">Subtotal</span>
            <span class="text-gray-900 font-medium">
              {{
                selectedPrice - selectedDiscount
                  | currency : "USD" : "symbol" : "1.2-2"
              }}
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Shipping</span>
            <span class="text-yellow-600 font-medium">
              {{
                cartDetails?.cartDetails?.[0]?.["DATA"].NET_AMOUNT -
                  cartDetails?.cartDetails?.[0]?.["DATA"].TOTAL_DISCOUNT_AMOUNT
                  | currency : "USD" : "symbol" : "1.2-2"
              }}
            </span>
          </div>
        </div>

        <div
          class="flex justify-between border-t border-gray-300 pt-2 text-sm font-bold text-gray-800"
        >
          <span>Total:</span>
          <span class="text-green-600">
            {{
              selectedPrice -
                selectedDiscount +
                (cartDetails?.cartDetails?.[0]?.["DATA"].NET_AMOUNT -
                  cartDetails?.cartDetails?.[0]?.["DATA"].TOTAL_DISCOUNT_AMOUNT)
                | number : "1.2-2"
                | currency : "USD"
            }}</span
          >
        </div>
      </div>

      <!-- Buttons -->
      <!-- <div class="text-center">
        <button
          class="w-full py-2 bg-[#5a8f69] text-white text-sm font-semibold rounded-lg shadow-md hover:bg-emerald-700 transition"
          (click)="downloadInvoice()"
          [disabled]="!enableDownload"
        >
          <ng-container *ngIf="isDownloading; else normalText">
            <span
              class="loader border-t-2 border-white rounded-full w-4 h-4 animate-spin"
            ></span>
            Downloading...
          </ng-container>
          <ng-template #normalText>
            <span
              ><i class="ri-file-download-line mr-2"></i> Download Invoice</span
            >
          </ng-template>
        </button>
      </div> -->

      <div class="text-center pt-1">
        <a
          (click)="goToProductListing()"
          class="text-blue-600 hover:text-blue-800 font-medium underline text-xs cursor-pointer"
        >
          Continue Shopping
        </a>
        <p class="mt-2 text-[11px] text-gray-400">
          Any questions? Email us at
          <a
            href="mailto:ojasvidermacare@gmail.com"
            class="text-blue-500 hover:underline"
            >ojasvidermacare@gmail.com</a
          >
        </p>
      </div>
    </div>
  </div>
</div>
