<div
  class="bg-gray-50 w-full max-w-5xl mx-auto flex flex-col rounded-lg shadow-sm overflow-hidden my-6"
  style="max-height: calc(100vh - 8rem)"
  (click)="$event.stopPropagation()"
>
  <!-- Header -->
  <div
    class="border-b border-gray-200 px-4 py-3 flex justify-between items-center flex-shrink-0"
  >
    <h2 class="text-lg font-semibold text-gray-900">Shopping Cart</h2>
  </div>

  <!-- Loader -->
  <!-- <app-common-loader
    *ngIf="loadingProducts"
    class="overlay-loader"
  ></app-common-loader> -->

  <!-- Scrollable Main Area -->
  <div
    class="flex-1 flex flex-col lg:flex-row gap-4 p-4 sm:p-5 overflow-y-auto"
    style="max-height: calc(100vh - 12rem)"
  >
    <div class="flex-1 flex flex-col lg:max-w-3xl">
      <ng-container *ngIf="!loader; else loadingState">
        <ng-container *ngIf="cartItems.length > 0; else emptyCart">
          <div
            class="flex flex-col space-y-3 overflow-y-auto max-h-[70vh] p-1 pb-4"
          >
            <div
              *ngFor="let item of cartItems"
              class="flex items-center border border-gray-200 rounded-lg p-3 relative bg-white"
              style="height: 130px"
            >
              <button
                (click)="confirmDelete(item)"
                class="absolute top-2 right-2 text-red-500 hover:text-red-600 transition"
                title="Remove Item"
              >
                <i class="ri-delete-bin-line ri-lg"></i>
              </button>

              <img
                [src]="producctImageurl + getImageArray(item)"
                [alt]="item.NAME"
                class="w-24 h-[110px] rounded-md object-cover flex-shrink-0"
              />

              <div class="ml-3 flex-1 flex flex-col justify-between">
                <h3 class="font-semibold text-gray-900 text-sm truncate">
                  {{ item.NAME || item.PRODUCT_NAME }}
                </h3>
                <p class="text-gray-500 text-xs">
                  {{ item.VERIENT_SIZE }} {{ item.VERIENT_UNIT_NAME }}
                </p>

                <div class="mt-1">
                  <div class="flex items-center gap-2 md:gap-3 flex-wrap">
                    <p
                      class="font-bold text-green-700"
                      *ngIf="item.IS_VERIENT_AVAILABLE == 1"
                    >
                      ${{
                        item.DISCOUNT_TYPE == "Amount"
                          ? (item.VERIENT_RATE - item.DISCOUNT).toFixed(2)
                          : (
                              item.VERIENT_RATE -
                              (item.VERIENT_RATE * item.DISCOUNT) / 100
                            ).toFixed(2)
                      }}
                    </p>
                    <p
                      class="text-xs md:text-base text-gray-400 line-through font-medium"
                      *ngIf="item.DISCOUNT && item.DISCOUNT > 0"
                    >
                      ${{ item.VERIENT_RATE?.toFixed(2) || "0.00" }}
                    </p>
                    <p
                      class="inline-flex items-center px-2 py-0.5 md:px-3 md:py-1 bg-red-100 text-red-700 md:text-sm font-bold rounded-full"
                      *ngIf="item.DISCOUNT && item.DISCOUNT > 0"
                    >
                      Save
                      {{
                        item.DISCOUNT_TYPE == "Amount"
                          ? "$" + item.DISCOUNT
                          : item.DISCOUNT + "%"
                      }}
                    </p>
                  </div>
                </div>

                <div class="flex items-center space-x-2">
                  <ng-container *ngIf="item.quantity > 1; else deleteBtn">
                    <button
                      (click)="decreaseQty(item); updateTotals()"
                      class="text-gray-500 hover:text-[#5a8f69] text-sm"
                    >
                      <i class="ri-subtract-line"></i>
                    </button>
                  </ng-container>
                  <ng-template #deleteBtn>
                    <button
                      (click)="confirmDelete(item)"
                      class="text-gray-500 hover:text-red-500 text-sm"
                    >
                      <i class="ri-delete-bin-line"></i>
                    </button>
                  </ng-template>
                  <span class="w-6 text-center text-sm font-medium">
                    {{ item.quantity }}
                  </span>
                  <button
                    [disabled]="
                      item.PRODUCT_CURRENT_STOCK <= 0 &&
                      item.VERIENT_CURRENT_STOCK <= 0
                    "
                    (click)="increaseQty(item); updateTotals()"
                    class="text-gray-500 hover:text-[#5a8f69] text-sm"
                  >
                    <i class="ri-add-line"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #emptyCart>
          <div
            class="flex flex-col items-center justify-center text-center py-2 text-gray-500"
          >
            <img
              src="assets/img/empty-cart.png"
              alt="Empty Cart"
              class="w-32 h-32 mb-4"
            />
            <h2 class="text-base font-semibold mb-2">Your cart is empty</h2>
            <p class="text-sm mb-5">
              Looks like you haven't added anything to your cart yet.
            </p>
            <button
              (click)="close()"
              class="bg-[#5a8f69] text-white px-3 py-1.5 rounded-md hover:bg-[#4a7f59] transition text-sm"
            >
              Continue Shopping
            </button>
          </div>
        </ng-template>
      </ng-container>

      <ng-template #loadingState>
              <div class="col-span-full loader-container">
            <div class="loader-content text-center">
              <div class="logo-wrapper">
                <img
                  src="assets/img/logo1.png"
                  alt="Ojasvi Logo"
                  class="ojasvi-logo"
                />
                <div class="processing-ring"></div>
              </div>
            </div>
          </div>    
      </ng-template>
    </div>

    <div
      *ngIf="cartItems.length > 0 && !loader"
      class="w-full lg:w-72 border border-gray-200 rounded-lg p-3 flex flex-col space-y-3 flex-shrink-0 lg:self-start bg-white sticky top-4"
    >
      <h3 class="text-base font-semibold text-gray-900">Order Summary</h3>

      <div
        class="flex justify-between text-gray-700 text-sm"
        *ngIf="cartItems.length > 0"
      >
        <span>Price</span>
        <span *ngIf="selectedTotal > 0">
          ${{ selectedPrice | number : "1.2-2" }}
        </span>
      </div>

      <div
        class="flex justify-between text-gray-700 text-sm"
        *ngIf="selectedDiscount > 0 && selectedTotal && cartItems.length > 0"
      >
        <span>Discount</span>
        <span>-${{ selectedDiscount | number : "1.2-2" }}</span>
      </div>

      <div
        class="flex justify-between font-semibold text-gray-900 text-base border-t border-gray-200 pt-2"
      >
        <span>Total</span>
        <span *ngIf="selectedTotal && cartItems.length > 0"
          >${{ selectedPrice - selectedDiscount | number : "1.2-2" }}</span
        >
      </div>

      <button
        [disabled]="cartItems.length === 0 && nextTotalSize <= 0"
        (click)="proceedToCheckout()"
        class="w-full bg-[#5a8f69] text-white px-3 py-2 rounded-md font-medium hover:bg-[#4a7f59] transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Proceed To Checkout
      </button>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div
    *ngIf="showDeleteConfirmation"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    (click)="cancelDelete()"
  >
    <div
      class="bg-white rounded-lg shadow-sm p-6 max-w-sm w-full mx-4"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center mb-4">
        <div
          class="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center"
        >
          <i class="ri-alert-line text-red-600 text-2xl"></i>
        </div>
        <h3 class="ml-3 text-lg font-semibold text-gray-900">Remove Item?</h3>
      </div>

      <p class="text-gray-600 text-sm mb-6">
        Are you sure you want to remove "{{
          itemToDelete?.NAME || itemToDelete?.PRODUCT_NAME
        }}" from your cart?
      </p>

      <div class="flex gap-3 justify-end">
        <button
          (click)="cancelDelete()"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition"
        >
          Cancel
        </button>
        <button
          (click)="executeDelete()"
          class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition"
        >
          Yes
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="isCheckoutVisible">
  <app-checkout
    [cartDetails]="senddatatoCheckout"
    [subtotal]="subtotal"
    [selectedDiscount]="selectedDiscount"
    [selectedPrice]="selectedPrice"
    [addressDrawerOpen]="isCheckoutVisible"
    [userId]="userID"
    (orderPlaced)="onOrderPlaced($event)"
    (visibleChange)="isCheckoutVisible = false"
  ></app-checkout>
</div>
