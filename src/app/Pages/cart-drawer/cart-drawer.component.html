<div
  class="bg-gray-50 w-full max-w-5xl mx-auto flex flex-col rounded-lg shadow-lg overflow-hidden my-6"
  style="max-height: calc(100vh - 8rem)"
  (click)="$event.stopPropagation()"
>
  <!-- Header -->
  <div
    class="border-b border-gray-200 px-4 py-3 flex justify-between items-center flex-shrink-0"
  >
    <h2 class="text-lg font-semibold text-gray-900">Shopping Cart</h2>
    <!-- <button
      (click)="close()"
      class="text-gray-500 hover:text-gray-700 transition"
    >
      <i class="ri-close-line ri-lg"></i>
    </button> -->
  </div>

  <!-- Loader -->
  <app-common-loader
    *ngIf="loadingProducts"
    class="overlay-loader"
  ></app-common-loader>

  <!-- Scrollable Main Area -->
  <div
    class="flex-1 flex flex-col lg:flex-row gap-4 p-4 sm:p-5 overflow-y-auto"
    style="max-height: calc(100vh - 12rem)"
  >
    <!-- Cart Items -->
    <div class="flex-1 flex flex-col space-y-3 lg:max-w-3xl">
      <ng-container *ngIf="cartItems.length > 0; else emptyCart">
        <div
          *ngFor="let item of cartItems"
          class="flex items-center border border-gray-200 rounded-lg p-3 relative bg-white"
          style="height: 130px"
        >
          <!-- Checkbox -->
          <input
            type="checkbox"
            [(ngModel)]="item.selected"
            (change)="updateTotals()"
            class="absolute top-2 left-2 z-10 w-4 h-4 accent-[#5a8f69] cursor-pointer"
          />

          <!-- Delete Button (Top Right Corner) -->
          <button
            (click)="deleteItem(item); updateTotals()"
            class="absolute top-2 right-2 text-red-500 hover:text-red-600 transition"
            title="Remove Item"
          >
            <i class="ri-delete-bin-line ri-lg"></i>
          </button>

          <!-- Product Image -->
          <img
            [src]="producctImageurl + getImageArray(item)"
            [alt]="item.NAME"
            class="w-24 h-[110px] rounded-md object-cover flex-shrink-0"
          />

          <!-- Product Details -->
          <div class="ml-3 flex-1 flex flex-col justify-between">
            <h3 class="font-semibold text-gray-900 text-sm truncate">
              {{ item.NAME || item.PRODUCT_NAME }}
            </h3>
            <p class="text-gray-500 text-xs">
              {{ item.VERIENT_SIZE }} {{ item.VERIENT_UNIT_NAME }}
            </p>
            <!-- <p class="text-gray-700 font-medium text-sm">
              ${{ item.ITEM_DISCOUNT_AMOUNT || item.RATE || item.VERIENT_RATE }}
            </p> -->
            <div class="mt-1">
              <div class="flex items-center gap-2 md:gap-3 flex-wrap">
                <p
                  class="font-bold text-green-700"
                  *ngIf="item.IS_VERIENT_AVAILABLE == 1"
                >
                  ${{
                    item.DISCOUNT_TYPE == "Amount"
                      ? (item.VERIENT_RATE - item.DISCOUNT).toFixed(2)
                      : (
                          item.VERIENT_RATE -
                          (item.VERIENT_RATE * item.DISCOUNT) / 100
                        ).toFixed(2)
                  }}
                </p>
                <p
                  class="text-xs md:text-base text-gray-400 line-through font-medium"
                  *ngIf="item.DISCOUNT && item.DISCOUNT > 0"
                >
                  ${{ item.VERIENT_RATE?.toFixed(2) || "0.00" }}
                </p>
                <p
                  class="inline-flex items-center px-2 py-0.5 md:px-3 md:py-1 bg-red-100 text-red-700 md:text-sm font-bold rounded-full"
                  *ngIf="item.DISCOUNT && item.DISCOUNT > 0"
                >
                  Save
                  {{
                    item.DISCOUNT_TYPE == "Amount"
                      ? "$" + item.DISCOUNT
                      : item.DISCOUNT + "%"
                  }}
                </p>
              </div>
            </div>
            <!-- Quantity Controls -->
            <div class="flex items-center space-x-2">
              <ng-container *ngIf="item.quantity > 1; else deleteBtn">
                <button
                  (click)="decreaseQty(item); updateTotals()"
                  class="text-gray-500 hover:text-[#5a8f69] text-sm"
                >
                  <i class="ri-subtract-line"></i>
                </button>
              </ng-container>
              <ng-template #deleteBtn>
                <button
                  (click)="deleteItem(item); updateTotals()"
                  class="text-gray-500 hover:text-red-500 text-sm"
                >
                  <i class="ri-delete-bin-line"></i>
                </button>
              </ng-template>
              <span class="w-6 text-center text-sm font-medium">
                {{ item.quantity }}
              </span>
              <button
                (click)="increaseQty(item); updateTotals()"
                class="text-gray-500 hover:text-[#5a8f69] text-sm"
              >
                <i class="ri-add-line"></i>
              </button>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- Empty Cart -->
      <ng-template #emptyCart>
        <div
          class="flex flex-col items-center justify-center text-center py-2 text-gray-500"
        >
          <img
            src="assets/img/empty-cart.png"
            alt="Empty Cart"
            class="w-32 h-32 mb-4"
          />
          <h2 class="text-base font-semibold mb-2">Your cart is empty</h2>
          <p class="text-sm mb-5">
            Looks like you haven't added anything to your cart yet.
          </p>
          <button
            (click)="close()"
            class="bg-[#5a8f69] text-white px-3 py-1.5 rounded-md hover:bg-[#4a7f59] transition text-sm"
          >
            Continue Shopping
          </button>
        </div>
      </ng-template>
    </div>

    <!-- Order Summary -->
    <div
      class="w-full lg:w-72 border border-gray-200 rounded-lg p-3 flex flex-col space-y-3 flex-shrink-0 lg:self-start bg-white sticky top-4"
    >
      <h3 class="text-base font-semibold text-gray-900">Order Summary</h3>

      <!-- PRICE -->
      <div
        class="flex justify-between text-gray-700 text-sm"
        *ngIf="hasSelectedItems()"
      >
        <span>Price</span>
        <span *ngIf="selectedTotal > 0">
          ${{ selectedPrice | number : "1.2-2" }}
        </span>
      </div>

      <!-- DISCOUNT (shown once) -->
      <div
        class="flex justify-between text-gray-700 text-sm"
        *ngIf="
          selectedDiscount > 0 &&
          selectedTotal &&
          cartItems.length > 0 &&
          hasSelectedItems()
        "
      >
        <span>Discount</span>
        <span>-${{ selectedDiscount | number : "1.2-2" }}</span>
      </div>

      <!-- TOTAL -->
      <div
        class="flex justify-between font-semibold text-gray-900 text-base border-t border-gray-200 pt-2"
      >
        <span>Total</span>
        <span
          *ngIf="selectedTotal && cartItems.length > 0 && hasSelectedItems()"
          >${{ selectedPrice - selectedDiscount | number : "1.2-2" }}</span
        >
      </div>

      <!-- BUTTON -->
      <button
        [disabled]="!hasSelectedItems()"
        (click)="proceedToCheckout()"
        class="w-full bg-[#5a8f69] text-white px-3 py-2 rounded-md font-medium hover:bg-[#4a7f59] transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Proceed to Checkout
      </button>
    </div>
  </div>
</div>

<div *ngIf="isCheckoutVisible">
  <app-checkout
    [cartDetails]="senddatatoCheckout"
    [subtotal]="subtotal"
     [selectedDiscount]="selectedDiscount"
  [selectedPrice]="selectedPrice"
    [addressDrawerOpen]="isCheckoutVisible"
    [userId]="userID"
    (orderPlaced)="onOrderPlaced($event)"
    (visibleChange)="isCheckoutVisible = false"
  ></app-checkout>
</div>
